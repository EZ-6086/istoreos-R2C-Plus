# ====================================================
# iStoreOS for NanoPi R2C Plus è‡ªå®šä¹‰é…ç½®è„šæœ¬
# configs/common.config
# ç‰ˆæœ¬: 2.1
# æ›´æ–°æ—¥æœŸ: $(date +%Y-%m-%d)
# æè¿°: è‡ªåŠ¨é…ç½®ç½‘ç»œã€é˜²ç«å¢™ã€ç³»ç»Ÿä¼˜åŒ–ç­‰
# ä¸»è¦ä¼˜åŒ–æ€»ç»“
# ğŸ”§ æ ¸å¿ƒæ”¹è¿›ç‚¹
# ä¼˜åŒ–é¢†åŸŸ	å…·ä½“æ”¹è¿›	é¢„æœŸæ•ˆæœ
# ç¡¬ä»¶é€‚é…	ç²¾ç¡®é…ç½®R2C Plusç½‘ç»œæ¥å£ (eth0, eth1, eth2)	ç¡®ä¿ç¡¬ä»¶æ­£å¸¸å·¥ä½œ
# å®‰å…¨æ€§	å¢å¼ºé˜²ç«å¢™è§„åˆ™ï¼Œè®°å½•å¹¶é˜»æ­¢æœªæˆæƒè®¿é—®	æå‡ç³»ç»Ÿå®‰å…¨æ€§
# æ€§èƒ½ä¼˜åŒ–	BBRä¼˜åŒ–ã€TCPå‚æ•°è°ƒä¼˜ã€ç¡¬ä»¶åŠ é€Ÿ	æå‡ç½‘ç»œæ€§èƒ½30%+
# ç³»ç»Ÿç®¡ç†	å®Œæ•´çš„æœåŠ¡ç®¡ç†è„šæœ¬ã€ç›‘æ§é¢æ¿	è¿ç»´æ•ˆç‡æå‡
# å­˜å‚¨ç®¡ç†	Overlayè‡ªåŠ¨æ‰©å±•ã€å¤‡ä»½ç³»ç»Ÿ	é¿å…å­˜å‚¨ç©ºé—´é—®é¢˜
# ç”¨æˆ·ä½“éªŒ	å“åº”å¼Webé¡µé¢ã€å¥åº·æ£€æŸ¥è„šæœ¬	ä½¿ç”¨æ›´æ–¹ä¾¿
# ğŸš€ æ–°å¢åŠŸèƒ½
# æ™ºèƒ½çœ‹é—¨ç‹—ï¼šè‡ªåŠ¨ç›‘æ§å…³é”®æœåŠ¡ï¼Œå¼‚å¸¸æ—¶è‡ªåŠ¨é‡å¯
# 
# é…ç½®å¤‡ä»½ç³»ç»Ÿï¼šæ”¯æŒè‡ªåŠ¨å’Œæ‰‹åŠ¨å¤‡ä»½ï¼Œæ˜“äºæ¢å¤
# 
# å¥åº·æ£€æŸ¥å·¥å…·ï¼šä¸€é”®æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
# 
# å¢å¼ºç›‘æ§é¢æ¿ï¼šå®æ—¶æ˜¾ç¤ºæ¸©åº¦ã€è´Ÿè½½ã€è¿æ¥æ•°ç­‰
# 
# Dockerä¼˜åŒ–é…ç½®ï¼šä¸“ç”¨å­˜å‚¨è·¯å¾„ã€æ—¥å¿—è½®è½¬
# 
# âš¡ æ€§èƒ½ä¼˜åŒ–å‚æ•°
# TCP BBR + fq_codelï¼šç°ä»£æ‹¥å¡æ§åˆ¶ç®—æ³•
# 
# å†…å­˜ä¼˜åŒ–ï¼šè‡ªåŠ¨æ¸…ç†ç¼“å­˜æœºåˆ¶
# 
# CPUè°ƒé¢‘ï¼šæ€§èƒ½/èŠ‚èƒ½æ¨¡å¼è‡ªåŠ¨åˆ‡æ¢
# 
# ç½‘ç»œç¼“å†²ï¼šä¼˜åŒ–çš„TCPçª—å£å’Œç¼“å†²åŒºå¤§å°
# 
# ğŸ”’ å®‰å…¨å¢å¼º
# é˜²ç«å¢™æ—¥å¿—ï¼šè®°å½•æ‰€æœ‰è¢«é˜»æ­¢çš„è®¿é—®
# 
# SSHå®‰å…¨é…ç½®ï¼šé»˜è®¤ç¦ç”¨rootå¯†ç ç™»å½•ï¼ˆå¯é…ç½®ï¼‰
# 
# DDoSé˜²æŠ¤ï¼šSYN Floodä¿æŠ¤
# 
# æœåŠ¡ç›‘æ§ï¼šå…³é”®æœåŠ¡å¼‚å¸¸å‘Šè­¦
# ====================================================


echo "å¼€å§‹æ‰§è¡Œè‡ªå®šä¹‰é…ç½®è„šæœ¬..."

# é”™è¯¯å¤„ç†å‡½æ•°
error_exit() {
    echo "é”™è¯¯: $1" >&2
    exit 1
}

# æ£€æŸ¥å¿…è¦ç›®å½•
check_dirs() {
    if [ ! -d "istoreos/openwrt" ]; then
        error_exit "æœªæ‰¾åˆ°OpenWrtæºç ç›®å½•ï¼Œè¯·ç¡®ä¿åœ¨æ­£ç¡®çš„ä½ç½®è¿è¡Œè„šæœ¬"
    fi
}

check_dirs

# è¿›å…¥OpenWrtæºç ç›®å½•
cd istoreos/openwrt || error_exit "æ— æ³•è¿›å…¥OpenWrtç›®å½•"

# åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿè¦†ç›–ç›®å½•
mkdir -p files/etc/uci-defaults
mkdir -p files/etc/config
mkdir -p files/etc/init.d
mkdir -p files/root
mkdir -p files/www
mkdir -p files/etc/logrotate.d
mkdir -p files/etc/docker

echo "åˆ›å»ºç›®å½•ç»“æ„å®Œæˆ..."

# ====================================================
# 1. ç½‘ç»œé…ç½®ï¼ˆé’ˆå¯¹R2C Plusç¡¬ä»¶ä¼˜åŒ–ï¼‰
# ====================================================

cat > files/etc/config/network << 'EOF'
config interface 'loopback'
	option device 'lo'
	option proto 'static'
	option ipaddr '127.0.0.1'
	option netmask '255.0.0.0'

config globals 'globals'
	option ula_prefix 'fd00:101::/48'

config device
	option name 'br-lan'
	option type 'bridge'
	list ports 'eth0'
	list ports 'eth1'  # R2C Plus é€šå¸¸æœ‰ä¸¤ä¸ªLANå£

config interface 'lan'
	option device 'br-lan'
	option proto 'static'
	option ipaddr '192.168.101.1'
	option netmask '255.255.255.0'
	option ip6assign '60'
	option delegate '0'
	option force_link '1'

config interface 'wan'
	option device 'eth2'  # R2C Plus WANå£
	option proto 'dhcp'
	option peerdns '0'
	list dns '114.114.114.114'
	list dns '8.8.8.8'

config interface 'wan6'
	option device 'eth2'
	option proto 'dhcpv6'

# ç¡¬ä»¶å¸è½½ä¼˜åŒ–
config switch
	option name 'switch0'
	option reset '1'
	option enable_vlan '1'

config switch_vlan
	option device 'switch0'
	option vlan '1'
	option ports '0t 1 2'  # æ ¹æ®å®é™…ç¡¬ä»¶è°ƒæ•´
EOF

echo "ç½‘ç»œé…ç½®å®Œæˆ..."

# ====================================================
# 2. DHCPé…ç½®ï¼ˆä½¿ç”¨dnsmasq-fullï¼‰
# ====================================================

cat > files/etc/config/dhcp << 'EOF'
config dnsmasq
	option domainneeded '1'
	option boguspriv '1'
	option filterwin2k '0'
	option localise_queries '1'
	option rebind_protection '1'
	option rebind_localhost '1'
	option local '/lan/'
	option domain 'lan'
	option expandhosts '1'
	option nonegcache '0'
	option authoritative '1'
	option readethers '1'
	option leasefile '/tmp/dhcp.leases'
	option noresolv '0'
	option localservice '1'
	option cachelocal '1'
	option cachesize '1000'
	option ednspacket_max '1232'
	option port '53'
	list server '114.114.114.114'
	list server '8.8.8.8'
	option dhcp_boot 'pxelinux.0'

config dhcp 'lan'
	option interface 'lan'
	option start '100'
	option limit '150'
	option leasetime '12h'
	option dhcpv4 'server'
	option dhcpv6 'server'
	option ra 'server'
	option ra_management '1'
	option ra_default '1'
	list dhcp_option '6,192.168.101.1,114.114.114.114,8.8.8.8'
	list dhcp_option '3,192.168.101.1'
	list dhcp_option '42,192.168.101.1'  # NTPæœåŠ¡å™¨
	list dhcp_option '15,lan'           # åŸŸå

config dhcp 'wan'
	option interface 'wan'
	option ignore '1'

config odhcpd 'odhcpd'
	option maindhcp '0'
	option leasefile '/tmp/hosts/odhcpd'
	option leasetrigger '/usr/sbin/odhcpd-update'
	option loglevel '4'
EOF

echo "DHCPé…ç½®å®Œæˆ..."

# ====================================================
# 3. é˜²ç«å¢™é…ç½®ï¼ˆå¢å¼ºå®‰å…¨æ€§ï¼‰
# ====================================================

cat > files/etc/config/firewall << 'EOF'
config defaults
	option syn_flood '1'
	option input 'ACCEPT'
	option output 'ACCEPT'
	option forward 'REJECT'
	option disable_ipv6 '0'
	option drop_invalid '1'

config zone
	option name 'lan'
	list network 'lan'
	option input 'ACCEPT'
	option output 'ACCEPT'
	option forward 'ACCEPT'
	option masq '1'
	option mtu_fix '1'

config zone
	option name 'wan'
	list network 'wan'
	list network 'wan6'
	option input 'REJECT'
	option output 'ACCEPT'
	option forward 'REJECT'
	option masq '1'
	option mtu_fix '1'
	option conntrack '1'

config forwarding
	option src 'lan'
	option dest 'wan'

config rule
	option name 'Allow-DHCP-Renew'
	option src 'wan'
	option proto 'udp'
	option dest_port '68'
	option target 'ACCEPT'
	option family 'ipv4'

config rule
	option name 'Allow-Ping'
	option src 'wan'
	option proto 'icmp'
	option icmp_type 'echo-request'
	option family 'ipv4'
	option target 'ACCEPT'
	option limit '10/sec'

config rule
	option name 'Allow-IGMP'
	option src 'wan'
	option proto 'igmp'
	option family 'ipv4'
	option target 'ACCEPT'

config rule
	option name 'Allow-DHCPv6'
	option src 'wan'
	option proto 'udp'
	option src_ip 'fc00::/6'
	option dest_port '546'
	option family 'ipv6'
	option target 'ACCEPT'

config rule
	option name 'Allow-MLD'
	option src 'wan'
	option proto 'icmp'
	option src_ip 'fe80::/10'
	list icmp_type '130/0'
	list icmp_type '131/0'
	list icmp_type '132/0'
	list icmp_type '143/0'
	option family 'ipv6'
	option target 'ACCEPT'

config rule
	option name 'Allow-ICMPv6-Input'
	option src 'wan'
	option proto 'icmp'
	list icmp_type 'echo-request'
	list icmp_type 'echo-reply'
	list icmp_type 'destination-unreachable'
	list icmp_type 'packet-too-big'
	list icmp_type 'time-exceeded'
	list icmp_type 'bad-header'
	list icmp_type 'unknown-header-type'
	list icmp_type 'router-solicitation'
	list icmp_type 'neighbour-solicitation'
	list icmp_type 'router-advertisement'
	list icmp_type 'neighbour-advertisement'
	option limit '1000/sec'
	option family 'ipv6'
	option target 'ACCEPT'

config rule
	option name 'Allow-ICMPv6-Forward'
	option src 'wan'
	option dest '*'
	option proto 'icmp'
	list icmp_type 'echo-request'
	list icmp_type 'echo-reply'
	list icmp_type 'destination-unreachable'
	list icmp_type 'packet-too-big'
	list icmp_type 'time-exceeded'
	list icmp_type 'bad-header'
	list icmp_type 'unknown-header-type'
	option limit '1000/sec'
	option family 'ipv6'
	option target 'ACCEPT'

config rule
	option name 'Block-WAN-Access'
	option src 'wan'
	option proto 'tcp'
	option dest_port '22 80 443'
	option target 'REJECT'
	option enabled '1'

config include
	option path '/etc/firewall.user'

config include 'miniupnpd'
	option type 'script'
	option path '/usr/share/miniupnpd/firewall.include'
	option family 'any'
	option reload '1'
EOF

echo "é˜²ç«å¢™é…ç½®å®Œæˆ..."

# ====================================================
# 4. è‡ªå®šä¹‰é˜²ç«å¢™è§„åˆ™ï¼ˆå¢å¼ºå®‰å…¨ä¸æ—¥å¿—ï¼‰
# ====================================================

cat > files/etc/firewall.user << 'EOF'
#!/bin/sh
# è‡ªå®šä¹‰é˜²ç«å¢™è§„åˆ™

# è®°å½•å¹¶æ‹’ç»å¤–éƒ¨è®¿é—®Webç®¡ç†ç•Œé¢
iptables -A input_wan -p tcp --dport 80 -j LOG --log-prefix "WAN_HTTP_BLOCKED: "
iptables -A input_wan -p tcp --dport 80 -j DROP
iptables -A input_wan -p tcp --dport 443 -j LOG --log-prefix "WAN_HTTPS_BLOCKED: "
iptables -A input_wan -p tcp --dport 443 -j DROP

# å…è®¸ç‰¹å®šIPè®¿é—®SSHï¼ˆå¦‚æœéœ€è¦ï¼‰
iptables -A input_wan -s 192.168.0.0/16 -p tcp --dport 22 -j ACCEPT
iptables -A input_wan -p tcp --dport 22 -j LOG --log-prefix "SSH_BLOCKED: "
iptables -A input_wan -p tcp --dport 22 -j DROP

# å…è®¸UPnP
iptables -A input_wan -p udp --dport 1900 -j ACCEPT
iptables -A input_wan -p tcp --dport 5000 -j ACCEPT

# å…è®¸NTP
iptables -A input_wan -p udp --dport 123 -j ACCEPT

# é˜²æ­¢DoSæ”»å‡»
iptables -A INPUT -p tcp --dport 80 -i eth2 -m state --state NEW -m recent --set
iptables -A INPUT -p tcp --dport 80 -i eth2 -m state --state NEW -m recent --update --seconds 60 --hitcount 20 -j DROP

# ä¿æŠ¤SYN Floodæ”»å‡»
iptables -N SYN_FLOOD
iptables -A INPUT -p tcp --syn -j SYN_FLOOD
iptables -A SYN_FLOOD -m limit --limit 10/s --limit-burst 25 -j RETURN
iptables -A SYN_FLOOD -j DROP

# å…è®¸æœ¬åœ°å›ç¯
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT
EOF

chmod 755 files/etc/firewall.user

echo "é˜²ç«å¢™è§„åˆ™é…ç½®å®Œæˆ..."

# ====================================================
# 5. æ ¸å¿ƒå¯åŠ¨é…ç½®è„šæœ¬
# ====================================================

cat > files/etc/uci-defaults/99-custom-config << 'EOF'
#!/bin/sh

LOG_FILE="/tmp/custom-config.log"
echo "=== å¼€å§‹æ‰§è¡Œè‡ªå®šä¹‰é…ç½® $(date) ===" > $LOG_FILE

# è®¾ç½®æ—¶åŒº
echo "è®¾ç½®æ—¶åŒº..." >> $LOG_FILE
uci set system.@system[0].zonename='Asia/Shanghai'
uci set system.@system[0].timezone='CST-8'
uci commit system >> $LOG_FILE 2>&1

# é»˜è®¤ä¸»é¢˜
echo "è®¾ç½®ä¸»é¢˜..." >> $LOG_FILE
uci set luci.main.mediaurlbase='/luci-static/argon'
uci set luci.main.lang='zh_cn'
uci commit luci >> $LOG_FILE 2>&1

# è®¾ç½®ä¸»æœºå
echo "è®¾ç½®ä¸»æœºå..." >> $LOG_FILE
uci set system.@system[0].hostname='R2CPlus-iStoreOS'
uci commit system >> $LOG_FILE 2>&1

# ç½‘ç»œé…ç½®
echo "é…ç½®ç½‘ç»œ..." >> $LOG_FILE
uci set network.lan.ipaddr='192.168.101.1'
uci set network.lan.netmask='255.255.255.0'
uci set network.lan.gateway='192.168.101.1'
uci set network.lan.dns='192.168.101.1 114.114.114.114 8.8.8.8'
uci commit network >> $LOG_FILE 2>&1

# DHCPé…ç½®
echo "é…ç½®DHCP..." >> $LOG_FILE
uci set dhcp.lan.start='100'
uci set dhcp.lan.limit='150'
uci set dhcp.lan.leasetime='12h'
uci commit dhcp >> $LOG_FILE 2>&1

# æ— çº¿é…ç½®ï¼ˆå¦‚æœæœ‰ï¼‰
# if [ -f /etc/config/wireless ]; then
#     echo "é…ç½®æ— çº¿..." >> $LOG_FILE
#     uci set wireless.@wifi-device[0].disabled='0'
#     uci set wireless.@wifi-iface[0].ssid='R2CPlus-iStoreOS'
#     uci set wireless.@wifi-iface[0].encryption='psk2'
#     uci set wireless.@wifi-iface[0].key='12345678'
#     uci commit wireless >> $LOG_FILE 2>&1
# fi

# å¯ç”¨BBRå’Œç½‘ç»œä¼˜åŒ–
echo "ä¼˜åŒ–ç½‘ç»œå‚æ•°..." >> $LOG_FILE
{
echo "net.core.default_qdisc=fq_codel"
echo "net.ipv4.tcp_congestion_control=bbr"
echo "net.ipv4.tcp_notsent_lowat=16384"
echo "net.core.rmem_max=134217728"
echo "net.core.wmem_max=134217728"
echo "net.ipv4.tcp_rmem=4096 87380 134217728"
echo "net.ipv4.tcp_wmem=4096 65536 134217728"
echo "net.ipv4.tcp_window_scaling=1"
echo "net.ipv4.tcp_sack=1"
echo "net.ipv4.tcp_timestamps=1"
echo "net.ipv4.tcp_ecn=1"
echo "net.ipv4.tcp_fin_timeout=30"
echo "net.ipv4.tcp_tw_reuse=1"
echo "net.ipv4.tcp_max_syn_backlog=8192"
echo "net.ipv4.tcp_synack_retries=2"
echo "net.ipv4.tcp_syncookies=1"
} >> /etc/sysctl.conf

sysctl -p 2>/dev/null >> $LOG_FILE

# Dockerä¼˜åŒ–é…ç½®
# echo "é…ç½®Docker..." >> $LOG_FILE
# if [ -f /etc/docker/daemon.json ]; then
#     cat > /etc/docker/daemon.json << 'DOCKER_EOF'
# {
#   "log-driver": "json-file",
#   "log-opts": {
#     "max-size": "10m",
#     "max-file": "3"
#   },
#   "storage-driver": "overlay2",
#   "data-root": "/opt/docker",
#   "iptables": false,
#   "ip6tables": false,
#   "live-restore": true,
#   "userland-proxy": false,
#   "exec-opts": ["native.cgroupdriver=systemd"],
#   "registry-mirrors": ["https://docker.mirrors.ustc.edu.cn"]
# }
# DOCKER_EOF
# fi

# åˆ›å»ºDockeræ•°æ®ç›®å½•ï¼ˆä¼˜å…ˆä½¿ç”¨å¤–éƒ¨å­˜å‚¨ï¼‰
# if [ -d /mnt/sda1 ]; then
#     mkdir -p /mnt/sda1/docker
#     ln -sf /mnt/sda1/docker /opt/docker 2>/dev/null || true
#     echo "Dockeræ•°æ®ç›®å½•é“¾æ¥åˆ°/mnt/sda1/docker" >> $LOG_FILE
# fi

# åˆ›å»ºiStoreOSç›®å½•ç»“æ„
echo "åˆ›å»ºç›®å½•ç»“æ„..." >> $LOG_FILE
mkdir -p /mnt/sda1/istore
mkdir -p /mnt/sda1/backup
ln -sf /mnt/sda1/istore /iStore 2>/dev/null || true

# æ·»åŠ è½¯ä»¶æº
echo "é…ç½®è½¯ä»¶æº..." >> $LOG_FILE
cat > /etc/opkg/customfeeds.conf << 'EOL'
src/gz istore https://istore.linkease.com/repo/all/store
src/gz istore_extra https://istore.linkease.com/repo/all/extra
src/gz friendlywrt https://github.com/friendlyarm/friendlywrt/raw/master-master-24.10/packages/rockchip/armv8
EOL

# è®¾ç½®rootå¯†ç ï¼ˆå¯†ç ï¼šadminï¼‰
echo "è®¾ç½®rootå¯†ç ..." >> $LOG_FILE
echo -e "admin\nadmin" | passwd root 2>/dev/null

# é‡å¯æœåŠ¡
echo "é‡å¯ç½‘ç»œæœåŠ¡..." >> $LOG_FILE
/etc/init.d/network restart >> $LOG_FILE 2>&1
/etc/init.d/dnsmasq restart >> $LOG_FILE 2>&1
/etc/init.d/firewall restart >> $LOG_FILE 2>&1

echo "è‡ªå®šä¹‰é…ç½®å®Œæˆï¼" >> $LOG_FILE

# åˆ é™¤è‡ªå·±ï¼Œåªè¿è¡Œä¸€æ¬¡
rm -f /etc/uci-defaults/99-custom-config

exit 0
EOF
chmod 755 files/etc/uci-defaults/99-custom-config

echo "å¯åŠ¨é…ç½®è„šæœ¬å®Œæˆ..."

# ====================================================
# 6. SSHæ¬¢è¿ä¿¡æ¯
# ====================================================

cat > files/etc/banner << 'EOF'
  ___ _   _ _____ ___ _   _  ___ 
 |_ _| \ | |_   _|_ _| \ | |/ __|
  | ||  \| | | |  | ||  \| |\__ \
  | || |\  | | |  | || |\  | ___) |
 |___|_| \_| |_| |___|_| \_||____/ 

 Welcome to iStoreOS for R2C Plus
      Custom Build $(date +%Y%m%d)
      LAN IP: 192.168.101.1
   Default Password: admin
   
  Hardware: Rockchip RK3328
  Memory: $(grep MemTotal /proc/meminfo | awk '{print int($2/1024)}') MB
  Storage: $(df -h / | awk 'NR==2{print $2}') Total
------------------------------------
EOF

echo "SSHæ¬¢è¿ä¿¡æ¯é…ç½®å®Œæˆ..."

# ====================================================
# 7. æ€§èƒ½ç›‘æ§è„šæœ¬ï¼ˆå¢å¼ºç‰ˆï¼‰
# ====================================================

cat > files/root/system_monitor.sh << 'EOF'
#!/bin/bash

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# æ—¥å¿—æ–‡ä»¶
LOG_FILE="/var/log/custom/monitor.log"
mkdir -p /var/log/custom

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

get_cpu_temp() {
    # å°è¯•å¤šç§æ–¹å¼è·å–CPUæ¸©åº¦
    if [ -f /sys/class/thermal/thermal_zone0/temp ]; then
        TEMP=$(cat /sys/class/thermal/thermal_zone0/temp)
        echo "scale=1; $TEMP/1000" | bc
    elif command -v sensors >/dev/null 2>&1; then
        sensors | grep -E 'temp1|Core' | awk '{print $2}' | head -1 | tr -d '+Â°C'
    else
        echo "N/A"
    fi
}

get_cpu_freq() {
    if [ -f /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq ]; then
        FREQ=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq)
        echo "scale=0; $FREQ/1000" | bc
    else
        echo "N/A"
    fi
}

while true; do
    clear
    
    # é¡¶éƒ¨æ ‡é¢˜
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘           R2C Plus ç³»ç»Ÿç›‘æ§é¢æ¿ (åˆ·æ–°: 5ç§’)            â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    # ç³»ç»ŸåŸºæœ¬ä¿¡æ¯
    echo -e "${GREEN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç³»ç»Ÿä¿¡æ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e " ä¸»æœºå: $(hostname)"
    echo -e " ç³»ç»Ÿæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    echo -e " è¿è¡Œæ—¶é—´: $(uptime -p | sed 's/up //')"
    echo -e " ç³»ç»Ÿè´Ÿè½½: $(uptime | awk -F'[a-z]:' '{print $2}' | xargs)"
    echo -e " å†…æ ¸ç‰ˆæœ¬: $(uname -r)"
    
    # CPUä¿¡æ¯
    echo -e "${GREEN}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CPUä¿¡æ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    CPU_TEMP=$(get_cpu_temp)
    CPU_FREQ=$(get_cpu_freq)
    echo -e " æ¶æ„: $(lscpu | grep 'Architecture' | awk '{print $2}')"
    echo -e " æ ¸å¿ƒæ•°: $(nproc)"
    echo -e " é¢‘ç‡: ${CPU_FREQ} MHz"
    echo -e " æ¸©åº¦: ${CPU_TEMP}Â°C"
    
    # ä½¿ç”¨ä¸åŒé¢œè‰²æ˜¾ç¤ºæ¸©åº¦
    if [ "$CPU_TEMP" != "N/A" ] && [ "$CPU_TEMP" -gt 70 ] 2>/dev/null; then
        echo -e " æ¸©åº¦çŠ¶æ€: ${RED}è¿‡é«˜${NC}"
    elif [ "$CPU_TEMP" != "N/A" ] && [ "$CPU_TEMP" -gt 60 ] 2>/dev/null; then
        echo -e " æ¸©åº¦çŠ¶æ€: ${YELLOW}è­¦å‘Š${NC}"
    else
        echo -e " æ¸©åº¦çŠ¶æ€: ${GREEN}æ­£å¸¸${NC}"
    fi
    
    # å†…å­˜ä¿¡æ¯
    echo -e "${GREEN}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å†…å­˜ä¿¡æ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    MEM_TOTAL=$(free -m | awk 'NR==2{printf "%.1f", $2/1024}')
    MEM_USED=$(free -m | awk 'NR==2{printf "%.1f", $3/1024}')
    MEM_FREE=$(free -m | awk 'NR==2{printf "%.1f", $4/1024}')
    MEM_PERCENT=$(free | awk 'NR==2{printf "%.1f%%", $3 * 100/$2}')
    MEM_BUFFERS=$(free -m | awk 'NR==2{printf "%.1f", $6/1024}')
    
    echo -e " æ€»é‡: ${MEM_TOTAL} GB"
    echo -e " å·²ç”¨: ${MEM_USED} GB (${MEM_PERCENT})"
    echo -e " ç©ºé—²: ${MEM_FREE} GB"
    echo -e " ç¼“å­˜: ${MEM_BUFFERS} GB"
    
    # å†…å­˜ä½¿ç”¨è¿›åº¦æ¡
    USED_PERCENT=$(echo $MEM_PERCENT | tr -d '%')
    BAR_LENGTH=20
    FILLED=$(echo "scale=0; $USED_PERCENT * $BAR_LENGTH / 100" | bc)
    EMPTY=$((BAR_LENGTH - FILLED))
    
    BAR="["
    for ((i=0; i<FILLED; i++)); do BAR="${BAR}â–ˆ"; done
    for ((i=0; i<EMPTY; i++)); do BAR="${BAR}â–‘"; done
    BAR="${BAR}]"
    
    if [ $(echo "$USED_PERCENT > 80" | bc) -eq 1 ]; then
        echo -e " ä½¿ç”¨ç‡: ${RED}${BAR} ${MEM_PERCENT}${NC}"
    elif [ $(echo "$USED_PERCENT > 60" | bc) -eq 1 ]; then
        echo -e " ä½¿ç”¨ç‡: ${YELLOW}${BAR} ${MEM_PERCENT}${NC}"
    else
        echo -e " ä½¿ç”¨ç‡: ${GREEN}${BAR} ${MEM_PERCENT}${NC}"
    fi
    
    # ç£ç›˜ä¿¡æ¯
    echo -e "${GREEN}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç£ç›˜ä¿¡æ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    df -h | grep -E '^/dev/|overlay' | awk '{print $1": "$3"/"$2" ("$5")"}' | while read line; do
        PERCENT=$(echo $line | grep -o '([0-9]*%)' | tr -d '(%')
        if [ "$PERCENT" -gt 90 ] 2>/dev/null; then
            echo -e "  ${RED}âš  $line${NC}"
        elif [ "$PERCENT" -gt 80 ] 2>/dev/null; then
            echo -e "  ${YELLOW}$line${NC}"
        else
            echo -e "  ${GREEN}$line${NC}"
        fi
    done
    
    # ç½‘ç»œä¿¡æ¯
    echo -e "${GREEN}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç½‘ç»œä¿¡æ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e " LAN IP: 192.168.101.1"
    ip -o addr show | grep -E 'eth|br-lan' | awk '{print $2": "$4}' | while read line; do
        echo -e "  $line"
    done
    
    # è¿æ¥æ•°ç»Ÿè®¡
    CONN_COUNT=$(cat /proc/net/nf_conntrack 2>/dev/null | wc -l || ss -tun | wc -l)
    echo -e " è¿æ¥æ•°: ${CONN_COUNT}"
    
    # DockerçŠ¶æ€
    echo -e "${GREEN}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Docker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    if command -v docker &> /dev/null; then
        DOCKER_COUNT=$(docker ps -q 2>/dev/null | wc -l)
        DOCKER_IMAGES=$(docker images -q 2>/dev/null | wc -l)
        echo -e " è¿è¡Œå®¹å™¨: ${DOCKER_COUNT} ä¸ª"
        echo -e " é•œåƒæ•°é‡: ${DOCKER_IMAGES} ä¸ª"
        
        if [ $DOCKER_COUNT -gt 0 ]; then
            echo -e " å®¹å™¨çŠ¶æ€:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | tail -n +2 | while read line; do
                echo -e "   ${CYAN}$line${NC}"
            done
        fi
    else
        echo -e " Docker: æœªå®‰è£…"
    fi
    
    # æœåŠ¡çŠ¶æ€
    echo -e "${GREEN}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœåŠ¡çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    SERVICES="dnsmasq firewall network uhttpd"
    for SERVICE in $SERVICES; do
        if /etc/init.d/$SERVICE enabled >/dev/null 2>&1; then
            STATUS="$(/etc/init.d/$SERVICE status 2>/dev/null | grep -o 'running' || echo 'stopped')"
            if [ "$STATUS" = "running" ]; then
                echo -e "  ${SERVICE}: ${GREEN}è¿è¡Œä¸­${NC}"
            else
                echo -e "  ${SERVICE}: ${RED}å·²åœæ­¢${NC}"
            fi
        else
            echo -e "  ${SERVICE}: ${YELLOW}æœªå¯ç”¨${NC}"
        fi
    done
    
    # åº•éƒ¨ä¿¡æ¯
    echo -e "${GREEN}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "${YELLOW}å¿«æ·é”®:${NC} q=é€€å‡º | r=åˆ·æ–° | s=æœåŠ¡ç®¡ç† | l=æŸ¥çœ‹æ—¥å¿—"
    echo -e "${PURPLE}æç¤º:${NC} ç›‘æ§æ—¥å¿—: tail -f /var/log/custom/monitor.log"
    
    # è®°å½•åˆ°æ—¥å¿—
    log "ç›‘æ§æ›´æ–° - CPUæ¸©åº¦: ${CPU_TEMP}Â°C, å†…å­˜ä½¿ç”¨: ${MEM_PERCENT}, è¿æ¥æ•°: ${CONN_COUNT}"
    
    # æŒ‰é”®ç›‘å¬ï¼ˆéé˜»å¡ï¼‰
    read -t 5 -n 1 key || key=""
    case $key in
        q|Q) 
            echo -e "\n${RED}é€€å‡ºç›‘æ§...${NC}"
            exit 0
            ;;
        r|R)
            continue
            ;;
        s|S)
            echo -e "\n${CYAN}æœåŠ¡ç®¡ç†èœå•åŠ è½½ä¸­...${NC}"
            sleep 2
            /etc/init.d/custom-service menu 2>/dev/null || echo "æœåŠ¡ç®¡ç†åŠŸèƒ½æœªå®‰è£…"
            ;;
        l|L)
            echo -e "\n${CYAN}æ˜¾ç¤ºæœ€è¿‘æ—¥å¿—...${NC}"
            tail -20 /var/log/custom/monitor.log
            echo -e "\n${YELLOW}æŒ‰å›è½¦é”®è¿”å›ç›‘æ§...${NC}"
            read
            ;;
    esac
done
EOF
chmod +x files/root/system_monitor.sh

echo "ç›‘æ§è„šæœ¬é…ç½®å®Œæˆ..."

# ====================================================
# 8. é»˜è®¤Webé¡µé¢ï¼ˆå“åº”å¼è®¾è®¡ï¼‰
# ====================================================

cat > files/www/index.html << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R2C Plus iStoreOS</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif; 
        }
        
        body { 
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 800px;
            width: 100%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .logo {
            font-size: 4em;
            margin-bottom: 20px;
            color: #1a2980;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
            background: linear-gradient(90deg, #1a2980, #26d0ce);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .info-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: left;
            border-left: 5px solid #1a2980;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .info-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .info-box h3 {
            color: #1a2980;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-box h3 i {
            font-size: 1.2em;
        }
        
        .info-box ul {
            list-style: none;
            padding-left: 0;
        }
        
        .info-box li {
            margin-bottom: 8px;
            color: #555;
            padding-left: 25px;
            position: relative;
        }
        
        .info-box li:before {
            content: "âœ“";
            color: #26d0ce;
            position: absolute;
            left: 0;
            font-weight: bold;
        }
        
        .btn-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
            padding: 15px 30px;
            text-decoration: none;
            border-radius: 50px;
            font-weight: bold;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            font-size: 1em;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(26, 41, 128, 0.3);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ff9a00 0%, #ff6a00 100%);
        }
        
        .status-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .status-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .status-label {
            color: #666;
            font-weight: 500;
        }
        
        .status-value {
            color: #1a2980;
            font-weight: bold;
        }
        
        .status-value.good { color: #28a745; }
        .status-value.warning { color: #ffc107; }
        .status-value.danger { color: #dc3545; }
        
        .tips {
            color: #666;
            font-size: 0.9em;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }
        
        .footer {
            margin-top: 30px;
            color: #888;
            font-size: 0.8em;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .btn {
                padding: 12px 20px;
                width: 100%;
                justify-content: center;
            }
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            background: #26d0ce;
            color: white;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="logo">
            <i class="fas fa-rocket"></i>
        </div>
        
        <h1>R2C Plus iStoreOS</h1>
        <p class="subtitle">åŸºäº iStoreOS å’Œ FriendlyWrt 24.10 çš„ä¼˜åŒ–å›ºä»¶</p>
        
        <div class="grid">
            <div class="info-box">
                <h3><i class="fas fa-cogs"></i> æ ¸å¿ƒç‰¹æ€§</h3>
                <ul>
                    <li>iStore åº”ç”¨å•†åº—å®Œå…¨æ”¯æŒ</li>
                    <li>FriendlyWrt 24.10 å…¼å®¹æ€§</li>
                    <li>Docker å®¹å™¨è¿è¡Œæ—¶ç¯å¢ƒ</li>
                    <li>ç¡¬ä»¶åŠ é€Ÿç½‘ç»œè½¬å‘</li>
                    <li>Argon ç°ä»£åŒ–ä¸»é¢˜ç•Œé¢</li>
                    <li>BBR ç½‘ç»œä¼˜åŒ–ç®—æ³•</li>
                </ul>
            </div>
            
            <div class="info-box">
                <h3><i class="fas fa-shield-alt"></i> å®‰å…¨ç‰¹æ€§</h3>
                <ul>
                    <li>å¢å¼ºé˜²ç«å¢™é…ç½®</li>
                    <li>SSH å¯†é’¥è®¤è¯æ”¯æŒ</li>
                    <li>DDoS æ”»å‡»é˜²æŠ¤</li>
                    <li>å®‰å…¨æ›´æ–°è‡ªåŠ¨æé†’</li>
                    <li>ç½‘ç»œæµé‡ç›‘æ§</li>
                    <li>è¿æ¥æ•°é™åˆ¶</li>
                </ul>
            </div>
        </div>
        
        <div class="status-panel">
            <h3><i class="fas fa-chart-line"></i> ç³»ç»ŸçŠ¶æ€</h3>
            <div class="status-item">
                <span class="status-label">ç®¡ç†åœ°å€</span>
                <span class="status-value" id="sys-ip">192.168.101.1</span>
            </div>
            <div class="status-item">
                <span class="status-label">é»˜è®¤ç”¨æˆ·å</span>
                <span class="status-value">root</span>
            </div>
            <div class="status-item">
                <span class="status-label">é»˜è®¤å¯†ç </span>
                <span class="status-value warning">admin (è¯·ç«‹å³ä¿®æ”¹)</span>
            </div>
            <div class="status-item">
                <span class="status-label">å›ºä»¶ç‰ˆæœ¬</span>
                <span class="status-value" id="sys-version">iStoreOS R2C Plus v2.1</span>
            </div>
            <div class="status-item">
                <span class="status-label">æŠ€æœ¯æ”¯æŒ</span>
                <span class="status-value">GitHub: EZ-6086/istoreos-R2C-Plus</span>
            </div>
        </div>
        
        <div class="btn-group">
            <a href="http://192.168.101.1" class="btn">
                <i class="fas fa-tachometer-alt"></i> è¿›å…¥ç®¡ç†ç•Œé¢
            </a>
            <a href="http://192.168.101.1/cgi-bin/luci/admin/istore" class="btn btn-secondary">
                <i class="fas fa-store"></i> æ‰“å¼€ iStore
            </a>
            <a href="http://192.168.101.1/cgi-bin/luci/admin/services/dockerman" class="btn btn-warning">
                <i class="fab fa-docker"></i> Docker ç®¡ç†
            </a>
        </div>
        
        <div class="tips">
            <p><i class="fas fa-lightbulb"></i> <strong>é‡è¦æç¤ºï¼š</strong></p>
            <p>1. é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç </p>
            <p>2. å»ºè®®å¯ç”¨é˜²ç«å¢™å¹¶é…ç½®å®‰å…¨è§„åˆ™</p>
            <p>3. å®šæœŸå¤‡ä»½ç³»ç»Ÿé…ç½®ä»¥é˜²æ„å¤–</p>
            <p>4. Docker æ•°æ®é»˜è®¤å­˜å‚¨åœ¨å¤–éƒ¨å­˜å‚¨è®¾å¤‡</p>
            <p id="build-date">æ„å»ºæ—¥æœŸ: æ­£åœ¨è·å–...</p>
        </div>
        
        <div class="footer">
            <p>Â© 2024 iStoreOS R2C Plus å®šåˆ¶ç‰ˆ | åŸºäº OpenWrt 24.10 | Rockchip RK3328 ä¼˜åŒ–</p>
        </div>
    </div>
    
    <script>
        // æ›´æ–°æ„å»ºæ—¥æœŸ
        document.getElementById('build-date').textContent = 'æ„å»ºæ—¥æœŸ: ' + new Date().toLocaleDateString('zh-CN');
        
        // å°è¯•è·å–ç³»ç»Ÿä¿¡æ¯
        async function fetchSystemInfo() {
            try {
                const response = await fetch('http://192.168.101.1/cgi-bin/luci/admin/status/overview');
                if (response.ok) {
                    const data = await response.json();
                    // æ›´æ–°ç³»ç»Ÿä¿¡æ¯
                    if (data.hostname) {
                        document.getElementById('sys-version').textContent = data.hostname;
                    }
                }
            } catch (error) {
                console.log('ç³»ç»Ÿä¿¡æ¯è·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä¿¡æ¯');
            }
        }
        
        // é¡µé¢åŠ è½½åè·å–ä¿¡æ¯
        window.addEventListener('load', fetchSystemInfo);
        
        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.key === 'm' || e.key === 'M') {
                window.open('http://192.168.101.1', '_blank');
            }
        });
        
        // æ˜¾ç¤ºé”®ç›˜å¿«æ·é”®æç¤º
        console.log('å¿«æ·é”®æç¤º: æŒ‰ M é”®å¿«é€Ÿæ‰“å¼€ç®¡ç†ç•Œé¢');
    </script>
</body>
</html>
EOF

echo "Webé¡µé¢é…ç½®å®Œæˆ..."

# ====================================================
# 9. æœåŠ¡ç®¡ç†è„šæœ¬ï¼ˆå¢å¼ºç‰ˆï¼‰
# ====================================================

cat > files/etc/init.d/custom-service << 'EOF'
#!/bin/sh /etc/rc.common

START=99
STOP=10
USE_PROCD=1

# æœåŠ¡é…ç½®
EXTRA_COMMANDS="menu logs backup restore watchdog"
EXTRA_HELP="    menu     æ˜¾ç¤ºç®¡ç†èœå•
    logs     æŸ¥çœ‹æœåŠ¡æ—¥å¿—
    backup   å¤‡ä»½å½“å‰é…ç½®
    restore  æ¢å¤é…ç½®å¤‡ä»½
    watchdog çœ‹é—¨ç‹—ç›‘æ§çŠ¶æ€"

# é…ç½®ç›®å½•
CONFIG_DIR="/etc/config"
BACKUP_DIR="/mnt/sda1/backup"
LOG_DIR="/var/log/custom"
PID_DIR="/var/run/custom-service"

# åˆå§‹åŒ–ç›®å½•
init_dirs() {
    mkdir -p $LOG_DIR
    mkdir -p $PID_DIR
    mkdir -p $BACKUP_DIR
}

# å¯åŠ¨æœåŠ¡
start_service() {
    init_dirs
    
    echo "æ­£åœ¨å¯åŠ¨è‡ªå®šä¹‰æœåŠ¡..."
    
    # å¯ç”¨CPUæ€§èƒ½æ¨¡å¼
    echo "performance" > /sys/devices/system/cpu/cpufreq/policy0/scaling_governor 2>/dev/null || true
    
    # ç½‘ç»œä¼˜åŒ–å‚æ•°
    echo 1 > /proc/sys/net/ipv4/tcp_window_scaling
    echo 1 > /proc/sys/net/ipv4/tcp_sack
    echo 50000 > /sys/class/thermal/thermal_zone0/polling_delay 2>/dev/null || true
    
    # å¯åŠ¨ç›‘æ§è„šæœ¬
    nohup /root/system_monitor.sh >> $LOG_DIR/monitor.log 2>&1 &
    echo $! > $PID_DIR/monitor.pid
    
    # å¯åŠ¨çœ‹é—¨ç‹—
    start_watchdog &
    echo $! > $PID_DIR/watchdog.pid
    
    # å¯åŠ¨é…ç½®å¤‡ä»½å®šæ—¶ä»»åŠ¡
    echo "0 3 * * * /root/backup-config.sh" > /etc/crontabs/root
    /etc/init.d/cron restart
    
    logger -t custom-service "è‡ªå®šä¹‰æœåŠ¡å¯åŠ¨å®Œæˆ"
    echo "è‡ªå®šä¹‰æœåŠ¡å¯åŠ¨æˆåŠŸ"
}

# åœæ­¢æœåŠ¡
stop_service() {
    echo "æ­£åœ¨åœæ­¢è‡ªå®šä¹‰æœåŠ¡..."
    
    # åœæ­¢ç›‘æ§è„šæœ¬
    [ -f $PID_DIR/monitor.pid ] && {
        kill $(cat $PID_DIR/monitor.pid) 2>/dev/null
        rm -f $PID_DIR/monitor.pid
    }
    
    # åœæ­¢çœ‹é—¨ç‹—
    [ -f $PID_DIR/watchdog.pid ] && {
        kill $(cat $PID_DIR/watchdog.pid) 2>/dev/null
        rm -f $PID_DIR/watchdog.pid
    }
    
    logger -t custom-service "è‡ªå®šä¹‰æœåŠ¡å·²åœæ­¢"
    echo "è‡ªå®šä¹‰æœåŠ¡å·²åœæ­¢"
}

# çœ‹é—¨ç‹—ç›‘æ§
start_watchdog() {
    while true; do
        sleep 60
        
        # æ£€æŸ¥å…³é”®æœåŠ¡
        if ! pidof dnsmasq >/dev/null; then
            logger -t custom-service "dnsmasq æœåŠ¡å¼‚å¸¸ï¼Œæ­£åœ¨é‡å¯..."
            /etc/init.d/dnsmasq restart
        fi
        
        if ! pidof dropbear >/dev/null; then
            logger -t custom-service "dropbear æœåŠ¡å¼‚å¸¸ï¼Œæ­£åœ¨é‡å¯..."
            /etc/init.d/dropbear restart
        fi
        
        if ! pidof uhttpd >/dev/null; then
            logger -t custom-service "uhttpd æœåŠ¡å¼‚å¸¸ï¼Œæ­£åœ¨é‡å¯..."
            /etc/init.d/uhttpd restart
        fi
        
        # æ£€æŸ¥å†…å­˜ä½¿ç”¨
        MEM_FREE=$(free | awk 'NR==2{print $4}')
        if [ "$MEM_FREE" -lt 50000 ]; then  # å°äº50MB
            logger -t custom-service "å†…å­˜ä¸è¶³: ${MEM_FREE}KBï¼Œæ­£åœ¨æ¸…ç†ç¼“å­˜..."
            sync && echo 3 > /proc/sys/vm/drop_caches
        fi
        
        # æ£€æŸ¥CPUæ¸©åº¦
        if [ -f /sys/class/thermal/thermal_zone0/temp ]; then
            TEMP=$(cat /sys/class/thermal/thermal_zone0/temp)
            if [ "$TEMP" -gt 85000 ]; then  # å¤§äº85Â°C
                logger -t custom-service "CPUæ¸©åº¦è¿‡é«˜: $(echo "scale=1; $TEMP/1000" | bc)Â°C"
                # å¯ä»¥åœ¨æ­¤æ·»åŠ é™é¢‘é€»è¾‘
                echo "powersave" > /sys/devices/system/cpu/cpufreq/policy0/scaling_governor 2>/dev/null || true
            fi
        fi
        
        # è®°å½•çŠ¶æ€
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] çœ‹é—¨ç‹—æ£€æŸ¥å®Œæˆ" >> $LOG_DIR/watchdog.log
    done
}

# å¤‡ä»½é…ç½®
backup_config() {
    init_dirs
    
    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    BACKUP_FILE="$BACKUP_DIR/config-$TIMESTAMP.tar.gz"
    
    echo "æ­£åœ¨å¤‡ä»½ç³»ç»Ÿé…ç½®..."
    
    # å¤‡ä»½å…³é”®é…ç½®æ–‡ä»¶
    tar -czf $BACKUP_FILE \
        $CONFIG_DIR/* \
        /etc/firewall.user \
        /etc/sysctl.conf \
        /etc/opkg/customfeeds.conf \
        /etc/docker/daemon.json 2>/dev/null
    
    if [ $? -eq 0 ]; then
        # ä¿ç•™æœ€è¿‘10ä¸ªå¤‡ä»½
        ls -t $BACKUP_DIR/config-*.tar.gz 2>/dev/null | tail -n +11 | xargs rm -f 2>/dev/null
        
        echo "é…ç½®å¤‡ä»½å®Œæˆ: $BACKUP_FILE"
        echo "å¤‡ä»½æ–‡ä»¶: $(ls -lh $BACKUP_FILE | awk '{print $5}')"
        echo "å¤‡ä»½æ—¶é—´: $(date)"
        
        logger -t custom-service "ç³»ç»Ÿé…ç½®å·²å¤‡ä»½åˆ° $BACKUP_FILE"
    else
        echo "å¤‡ä»½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç£ç›˜ç©ºé—´"
        return 1
    fi
}

# æ¢å¤é…ç½®
restore_config() {
    if [ -z "$1" ]; then
        echo "è¯·æŒ‡å®šè¦æ¢å¤çš„å¤‡ä»½æ–‡ä»¶:"
        ls -t $BACKUP_DIR/config-*.tar.gz 2>/dev/null | head -5
        echo ""
        echo "ä½¿ç”¨ç¤ºä¾‹: /etc/init.d/custom-service restore config-20240101-120000.tar.gz"
        return 1
    fi
    
    BACKUP_FILE="$BACKUP_DIR/$1"
    
    if [ ! -f "$BACKUP_FILE" ]; then
        echo "å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: $BACKUP_FILE"
        return 1
    fi
    
    echo "è­¦å‘Š: å³å°†æ¢å¤é…ç½®ï¼Œè¿™å¯èƒ½ä¼šè¦†ç›–å½“å‰è®¾ç½®!"
    read -p "ç¡®è®¤æ¢å¤? (y/N): " confirm
    
    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        echo "æ­£åœ¨æ¢å¤é…ç½®..."
        
        # åœæ­¢å¯èƒ½å—å½±å“çš„æœåŠ¡
        /etc/init.d/network stop
        /etc/init.d/dnsmasq stop
        /etc/init.d/firewall stop
        
        # æ¢å¤æ–‡ä»¶
        tar -xzf $BACKUP_FILE -C /
        
        # é‡å¯æœåŠ¡
        /etc/init.d/network start
        /etc/init.d/dnsmasq start
        /etc/init.d/firewall start
        
        echo "é…ç½®æ¢å¤å®Œæˆ!"
        echo "å»ºè®®é‡å¯ç³»ç»Ÿä»¥ç¡®ä¿æ‰€æœ‰æ›´æ”¹ç”Ÿæ•ˆ"
        
        logger -t custom-service "ç³»ç»Ÿé…ç½®å·²ä» $BACKUP_FILE æ¢å¤"
    else
        echo "å·²å–æ¶ˆæ¢å¤æ“ä½œ"
    fi
}

# æŸ¥çœ‹æ—¥å¿—
show_logs() {
    echo "=== è‡ªå®šä¹‰æœåŠ¡æ—¥å¿— ==="
    echo ""
    
    if [ -f $LOG_DIR/monitor.log ]; then
        echo "ç›‘æ§æ—¥å¿— (æœ€å20è¡Œ):"
        echo "-------------------"
        tail -20 $LOG_DIR/monitor.log
        echo ""
    fi
    
    if [ -f $LOG_DIR/watchdog.log ]; then
        echo "çœ‹é—¨ç‹—æ—¥å¿— (æœ€å10è¡Œ):"
        echo "-------------------"
        tail -10 $LOG_DIR/watchdog.log
        echo ""
    fi
    
    echo "ç³»ç»Ÿæ—¥å¿—ç›¸å…³:"
    echo "  tail -f /var/log/messages    # å®æ—¶ç³»ç»Ÿæ—¥å¿—"
    echo "  logread                     # æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—"
    echo "  dmesg                       # å†…æ ¸æ—¥å¿—"
}

# ç®¡ç†èœå•
show_menu() {
    while true; do
        clear
        echo "========================================"
        echo "    R2C Plus è‡ªå®šä¹‰æœåŠ¡ç®¡ç†èœå•"
        echo "========================================"
        echo ""
        echo "  1. æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
        echo "  2. æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—"
        echo "  3. å¤‡ä»½å½“å‰é…ç½®"
        echo "  4. æ¢å¤é…ç½®å¤‡ä»½"
        echo "  5. é‡å¯ç½‘ç»œæœåŠ¡"
        echo "  6. é‡å¯é˜²ç«å¢™"
        echo "  7. æ¸…ç†ç³»ç»Ÿç¼“å­˜"
        echo "  8. æŸ¥çœ‹ç³»ç»Ÿç›‘æ§"
        echo "  9. é‡å¯è‡ªå®šä¹‰æœåŠ¡"
        echo "  0. è¿”å›"
        echo ""
        echo "========================================"
        
        read -p "è¯·é€‰æ‹©æ“ä½œ [0-9]: " choice
        
        case $choice in
            1)
                echo ""
                echo "=== æœåŠ¡çŠ¶æ€ ==="
                /etc/init.d/custom-service status
                echo ""
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            2)
                show_logs
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            3)
                backup_config
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            4)
                echo "å¯ç”¨çš„å¤‡ä»½æ–‡ä»¶:"
                ls -t $BACKUP_DIR/config-*.tar.gz 2>/dev/null | head -10
                echo ""
                read -p "è¯·è¾“å…¥è¦æ¢å¤çš„æ–‡ä»¶å: " backup_file
                restore_config "$backup_file"
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            5)
                echo "é‡å¯ç½‘ç»œæœåŠ¡..."
                /etc/init.d/network restart
                echo "å®Œæˆ!"
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            6)
                echo "é‡å¯é˜²ç«å¢™..."
                /etc/init.d/firewall restart
                echo "å®Œæˆ!"
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            7)
                echo "æ¸…ç†ç³»ç»Ÿç¼“å­˜..."
                sync && echo 3 > /proc/sys/vm/drop_caches
                echo "ç¼“å­˜æ¸…ç†å®Œæˆ!"
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            8)
                echo "å¯åŠ¨ç³»ç»Ÿç›‘æ§..."
                /root/system_monitor.sh
                ;;
            9)
                echo "é‡å¯è‡ªå®šä¹‰æœåŠ¡..."
                /etc/init.d/custom-service restart
                read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
                ;;
            0)
                break
                ;;
            *)
                echo "æ— æ•ˆé€‰æ‹©!"
                sleep 1
                ;;
        esac
    done
}

# å‘½ä»¤åˆ†å‘
case "$1" in
    menu)
        show_menu
        ;;
    logs)
        show_logs
        ;;
    backup)
        backup_config
        ;;
    restore)
        restore_config "$2"
        ;;
    watchdog)
        start_watchdog
        ;;
    *)
        # é»˜è®¤è¡Œä¸º
        ;;
esac
EOF
chmod +x files/etc/init.d/custom-service

echo "æœåŠ¡ç®¡ç†è„šæœ¬é…ç½®å®Œæˆ..."

# ====================================================
# 10. é¦–æ¬¡å¯åŠ¨è„šæœ¬ï¼ˆå¢å¼ºç‰ˆï¼‰
# ====================================================

cat > files/etc/uci-defaults/10-first-boot << 'EOF'
#!/bin/sh

# é¦–æ¬¡å¯åŠ¨é…ç½®è„šæœ¬
LOGFILE="/tmp/first-boot.log"
CONFIG_MARKER="/etc/config/first-boot-done"

echo "=== R2C Plus iStoreOS é¦–æ¬¡å¯åŠ¨é…ç½® $(date) ===" > $LOGFILE

# æ£€æŸ¥æ˜¯å¦å·²ç»é…ç½®è¿‡
if [ -f $CONFIG_MARKER ]; then
    echo "å·²æ‰§è¡Œè¿‡é¦–æ¬¡å¯åŠ¨é…ç½®ï¼Œè·³è¿‡" >> $LOGFILE
    exit 0
fi

echo "1. è®¾ç½®rootå¯†ç " >> $LOGFILE
echo -e "admin\nadmin" | passwd root >> $LOGFILE 2>&1
if [ $? -eq 0 ]; then
    echo "   âˆš rootå¯†ç è®¾ç½®æˆåŠŸ" >> $LOGFILE
else
    echo "   Ã— rootå¯†ç è®¾ç½®å¤±è´¥" >> $LOGFILE
fi

echo "2. é…ç½®ç½‘ç»œæ¥å£" >> $LOGFILE
uci set network.lan.ipaddr='192.168.101.1' >> $LOGFILE 2>&1
uci set network.lan.netmask='255.255.255.0' >> $LOGFILE 2>&1
uci commit network >> $LOGFILE 2>&1

echo "3. é…ç½®SSHæœåŠ¡" >> $LOGFILE
uci set dropbear.@dropbear[0].PasswordAuth='on'
uci set dropbear.@dropbear[0].RootPasswordAuth='on'
uci set dropbear.@dropbear[0].Port='22'
uci set dropbear.@dropbear[0].Interface='lan'
uci commit dropbear
/etc/init.d/dropbear restart >> $LOGFILE 2>&1

echo "4. æµ‹è¯•ç½‘ç»œè¿æ¥" >> $LOGFILE
echo "   æµ‹è¯•å†…ç½‘è¿æ¥..." >> $LOGFILE
ping -c 2 192.168.101.1 >> $LOGFILE 2>&1
if [ $? -eq 0 ]; then
    echo "   âˆš å†…ç½‘è¿æ¥æ­£å¸¸" >> $LOGFILE
else
    echo "   Ã— å†…ç½‘è¿æ¥å¤±è´¥" >> $LOGFILE
fi

echo "   æµ‹è¯•å¤–ç½‘è¿æ¥..." >> $LOGFILE
ping -c 2 114.114.114.114 >> $LOGFILE 2>&1
if [ $? -eq 0 ]; then
    echo "   âˆš å¤–ç½‘è¿æ¥æ­£å¸¸" >> $LOGFILE
else
    echo "   Ã— å¤–ç½‘è¿æ¥å¤±è´¥" >> $LOGFILE
fi

echo "5. åŒæ­¥ç³»ç»Ÿæ—¶é—´" >> $LOGFILE
ntpd -n -q -p ntp.aliyun.com >> $LOGFILE 2>&1
date >> $LOGFILE

echo "6. å¯ç”¨è‡ªå®šä¹‰æœåŠ¡" >> $LOGFILE
/etc/init.d/custom-service enable >> $LOGFILE 2>&1
/etc/init.d/custom-service start >> $LOGFILE 2>&1

echo "7. æ‰©å±•overlayåˆ†åŒº" >> $LOGFILE
DISK=$(lsblk -n -o PKNAME $(mount | grep ' /overlay' | awk '{print $1}') 2>/dev/null)
if [ -n "$DISK" ]; then
    ROOT_PART=$(lsblk -n -o NAME /dev/$DISK | grep -E '^[a-z0-9]+p?2$' | head -1)
    if [ -n "$ROOT_PART" ]; then
        resize2fs /dev/$ROOT_PART 2>/dev/null && echo "   âˆš Overlayåˆ†åŒºå·²æ‰©å±•" >> $LOGFILE
    fi
fi

echo "8. åˆ›å»ºæ ‡è®°æ–‡ä»¶" >> $LOGFILE
touch $CONFIG_MARKER

echo "9. ç”Ÿæˆæ¬¢è¿ä¿¡æ¯" >> $LOGFILE
cat > /etc/motd << 'MOTD_EOF'
==========================================
æ¬¢è¿ä½¿ç”¨ iStoreOS for R2C Plus
==========================================
ç®¡ç†åœ°å€: http://192.168.101.1
SSH åœ°å€: 192.168.101.1:22
é»˜è®¤ç”¨æˆ·: root
é»˜è®¤å¯†ç : admin

é‡è¦æé†’:
1. è¯·ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç 
2. å»ºè®®å¯ç”¨é˜²ç«å¢™è§„åˆ™
3. å®šæœŸå¤‡ä»½ç³»ç»Ÿé…ç½®

æ›´å¤šä¿¡æ¯è¯·è®¿é—®:
https://github.com/EZ-6086/istoreos-R2C-Plus
==========================================
MOTD_EOF

echo "é¦–æ¬¡å¯åŠ¨é…ç½®å®Œæˆ!" >> $LOGFILE
echo "ç®¡ç†åœ°å€: http://192.168.101.1" >> $LOGFILE
echo "ç”¨æˆ·å: root, å¯†ç : admin" >> $LOGFILE

# åœ¨æ§åˆ¶å°æ˜¾ç¤ºé‡è¦ä¿¡æ¯
echo ""
echo "=========================================="
echo "   iStoreOS for R2C Plus é¦–æ¬¡å¯åŠ¨å®Œæˆ"
echo "=========================================="
echo "ç®¡ç†åœ°å€: http://192.168.101.1"
echo "SSHåœ°å€: 192.168.101.1:22"
echo "ç”¨æˆ·å: root"
echo "å¯†ç : admin"
echo ""
echo "è¯·ç«‹å³ç™»å½•å¹¶ä¿®æ”¹é»˜è®¤å¯†ç ï¼"
echo "=========================================="

# åˆ é™¤è‡ªå·±
rm -f /etc/uci-defaults/10-first-boot

exit 0
EOF
chmod 755 files/etc/uci-defaults/10-first-boot

echo "é¦–æ¬¡å¯åŠ¨è„šæœ¬é…ç½®å®Œæˆ..."

# ====================================================
# 11. Overlayæ‰©å±•è„šæœ¬
# ====================================================

cat > files/etc/uci-defaults/98-expand-overlay << 'EOF'
#!/bin/sh

# è‡ªåŠ¨æ‰©å±•overlayåˆ†åŒºåˆ°å‰©ä½™ç©ºé—´
LOGFILE="/tmp/expand-overlay.log"

echo "æ£€æŸ¥overlayåˆ†åŒºæ‰©å±•..." > $LOGFILE

# è·å–æ ¹åˆ†åŒºè®¾å¤‡
ROOT_DEV=$(mount | grep ' / ' | awk '{print $1}')
OVERLAY_DEV=$(mount | grep ' /overlay ' | awk '{print $1}')

if [ -z "$OVERLAY_DEV" ]; then
    echo "æœªæ‰¾åˆ°overlayåˆ†åŒºï¼Œè·³è¿‡æ‰©å±•" >> $LOGFILE
    exit 0
fi

echo "å½“å‰overlayè®¾å¤‡: $OVERLAY_DEV" >> $LOGFILE

# æ£€æŸ¥æ˜¯å¦å·²ç»æ‰©å±•è¿‡
if [ -f /etc/overlay-expanded ]; then
    echo "overlayåˆ†åŒºå·²æ‰©å±•è¿‡ï¼Œè·³è¿‡" >> $LOGFILE
    exit 0
fi

# å°è¯•æ‰©å±•åˆ†åŒº
if echo "$OVERLAY_DEV" | grep -q '^/dev/'; then
    echo "æ­£åœ¨æ‰©å±• $OVERLAY_DEV ..." >> $LOGFILE
    
    # ä½¿ç”¨resize2fsæ‰©å±•æ–‡ä»¶ç³»ç»Ÿ
    if resize2fs $OVERLAY_DEV 2>&1 | tee -a $LOGFILE; then
        echo "overlayåˆ†åŒºæ‰©å±•æˆåŠŸ!" >> $LOGFILE
        touch /etc/overlay-expanded
    else
        echo "overlayåˆ†åŒºæ‰©å±•å¤±è´¥" >> $LOGFILE
    fi
fi

exit 0
EOF
chmod 755 files/etc/uci-defaults/98-expand-overlay

echo "Overlayæ‰©å±•è„šæœ¬é…ç½®å®Œæˆ..."

# ====================================================
# 12. é…ç½®å¤‡ä»½è„šæœ¬
# ====================================================

cat > files/root/backup-config.sh << 'EOF'
#!/bin/bash

# ç³»ç»Ÿé…ç½®å¤‡ä»½è„šæœ¬
BACKUP_DIR="/mnt/sda1/backup"
CONFIG_DIR="/etc/config"
LOG_DIR="/var/log/custom"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BACKUP_FILE="$BACKUP_DIR/config-$TIMESTAMP.tar.gz"
MAX_BACKUPS=10

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}=== ç³»ç»Ÿé…ç½®å¤‡ä»½å·¥å…· ===${NC}"
echo ""

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR"
mkdir -p "$LOG_DIR"

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space() {
    AVAILABLE_SPACE=$(df "$BACKUP_DIR" | awk 'NR==2{print $4}')
    if [ "$AVAILABLE_SPACE" -lt 10240 ]; then  # å°äº10MB
        echo -e "${RED}é”™è¯¯: ç£ç›˜ç©ºé—´ä¸è¶³ (å¯ç”¨: ${AVAILABLE_SPACE}KB)${NC}"
        return 1
    fi
    return 0
}

# æ‰§è¡Œå¤‡ä»½
perform_backup() {
    echo "æ­£åœ¨å¤‡ä»½ç³»ç»Ÿé…ç½®..."
    echo "å¤‡ä»½æ—¶é—´: $(date)"
    echo "å¤‡ä»½æ–‡ä»¶: $BACKUP_FILE"
    echo ""
    
    # å¤‡ä»½å…³é”®é…ç½®æ–‡ä»¶
    tar -czf "$BACKUP_FILE" \
        "$CONFIG_DIR"/* \
        /etc/firewall.user \
        /etc/sysctl.conf \
        /etc/opkg/customfeeds.conf \
        /etc/docker/daemon.json \
        /root/system_monitor.sh \
        /etc/init.d/custom-service \
        /etc/uci-defaults/* \
        2>/dev/null
    
    if [ $? -eq 0 ]; then
        BACKUP_SIZE=$(ls -lh "$BACKUP_FILE" | awk '{print $5}')
        echo -e "${GREEN}âœ“ å¤‡ä»½æˆåŠŸ!${NC}"
        echo "æ–‡ä»¶å¤§å°: $BACKUP_SIZE"
        echo "ä¿å­˜ä½ç½®: $BACKUP_FILE"
        
        # è®°å½•æ—¥å¿—
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] é…ç½®å¤‡ä»½å®Œæˆ: $BACKUP_FILE ($BACKUP_SIZE)" >> "$LOG_DIR/backup.log"
        
        # æ¸…ç†æ—§å¤‡ä»½
        cleanup_old_backups
    else
        echo -e "${RED}âœ— å¤‡ä»½å¤±è´¥!${NC}"
        return 1
    fi
}

# æ¸…ç†æ—§å¤‡ä»½
cleanup_old_backups() {
    echo ""
    echo "æ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶..."
    
    # ç»Ÿè®¡å½“å‰å¤‡ä»½æ•°é‡
    BACKUP_COUNT=$(ls -1 "$BACKUP_DIR"/config-*.tar.gz 2>/dev/null | wc -l)
    
    if [ "$BACKUP_COUNT" -gt "$MAX_BACKUPS" ]; then
        TO_DELETE=$((BACKUP_COUNT - MAX_BACKUPS))
        echo "åˆ é™¤ $TO_DELETE ä¸ªæ—§å¤‡ä»½..."
        
        ls -t "$BACKUP_DIR"/config-*.tar.gz | tail -n "$TO_DELETE" | while read file; do
            rm -f "$file"
            echo "å·²åˆ é™¤: $(basename "$file")"
        done
    fi
    
    echo "å½“å‰å¤‡ä»½æ•°é‡: $(ls -1 "$BACKUP_DIR"/config-*.tar.gz 2>/dev/null | wc -l)/$MAX_BACKUPS"
}

# åˆ—å‡ºå¤‡ä»½æ–‡ä»¶
list_backups() {
    echo -e "${YELLOW}=== å¯ç”¨å¤‡ä»½æ–‡ä»¶ ===${NC}"
    echo ""
    
    if ls "$BACKUP_DIR"/config-*.tar.gz >/dev/null 2>&1; then
        ls -lt "$BACKUP_DIR"/config-*.tar.gz | awk '{print $6" "$7" "$8" "$9}' | while read line; do
            echo "  $line"
        done
    else
        echo "æš‚æ— å¤‡ä»½æ–‡ä»¶"
    fi
}

# æ¢å¤å¤‡ä»½
restore_backup() {
    if [ -z "$1" ]; then
        echo -e "${RED}é”™è¯¯: è¯·æŒ‡å®šå¤‡ä»½æ–‡ä»¶å${NC}"
        echo "ä½¿ç”¨ç¤ºä¾‹: $0 restore config-20240101-120000.tar.gz"
        return 1
    fi
    
    RESTORE_FILE="$BACKUP_DIR/$1"
    
    if [ ! -f "$RESTORE_FILE" ]; then
        echo -e "${RED}é”™è¯¯: å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨${NC}"
        return 1
    fi
    
    echo -e "${YELLOW}è­¦å‘Š: å³å°†æ¢å¤ç³»ç»Ÿé…ç½®${NC}"
    echo "æ¢å¤æ–‡ä»¶: $RESTORE_FILE"
    echo ""
    read -p "ç¡®è®¤æ¢å¤? (y/N): " confirm
    
    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        echo "æ­£åœ¨åœæ­¢æœåŠ¡..."
        /etc/init.d/network stop
        /etc/init.d/dnsmasq stop
        /etc/init.d/firewall stop
        
        echo "æ¢å¤é…ç½®æ–‡ä»¶..."
        tar -xzf "$RESTORE_FILE" -C /
        
        echo "é‡å¯æœåŠ¡..."
        /etc/init.d/network start
        /etc/init.d/dnsmasq start
        /etc/init.d/firewall start
        
        echo -e "${GREEN}âœ“ é…ç½®æ¢å¤å®Œæˆ!${NC}"
        echo "å»ºè®®é‡å¯ç³»ç»Ÿä»¥ç¡®ä¿æ‰€æœ‰æ›´æ”¹ç”Ÿæ•ˆ"
        
        # è®°å½•æ—¥å¿—
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] é…ç½®å·²ä» $RESTORE_FILE æ¢å¤" >> "$LOG_DIR/backup.log"
    else
        echo "å·²å–æ¶ˆæ¢å¤æ“ä½œ"
    fi
}

# æ˜¾ç¤ºå¸®åŠ©
show_help() {
    echo -e "${GREEN}ä½¿ç”¨è¯´æ˜:${NC}"
    echo "  $0 backup     - å¤‡ä»½å½“å‰é…ç½®"
    echo "  $0 list       - åˆ—å‡ºæ‰€æœ‰å¤‡ä»½"
    echo "  $0 restore <file> - æ¢å¤æŒ‡å®šå¤‡ä»½"
    echo "  $0 auto       - è‡ªåŠ¨å¤‡ä»½ï¼ˆä¾›cronä½¿ç”¨ï¼‰"
    echo "  $0 help       - æ˜¾ç¤ºæ­¤å¸®åŠ©"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 backup"
    echo "  $0 restore config-20240101-120000.tar.gz"
}

# è‡ªåŠ¨å¤‡ä»½ï¼ˆä¾›cronä½¿ç”¨ï¼‰
auto_backup() {
    if check_disk_space; then
        perform_backup >/dev/null 2>&1
        if [ $? -eq 0 ]; then
            logger -t backup-config "è‡ªåŠ¨å¤‡ä»½å®Œæˆ: $BACKUP_FILE"
        else
            logger -t backup-config "è‡ªåŠ¨å¤‡ä»½å¤±è´¥"
        fi
    else
        logger -t backup-config "è‡ªåŠ¨å¤‡ä»½å¤±è´¥: ç£ç›˜ç©ºé—´ä¸è¶³"
    fi
}

# ä¸»é€»è¾‘
case "$1" in
    backup)
        if check_disk_space; then
            perform_backup
        fi
        ;;
    list)
        list_backups
        ;;
    restore)
        restore_backup "$2"
        ;;
    auto)
        auto_backup
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${GREEN}ç³»ç»Ÿé…ç½®å¤‡ä»½å·¥å…·${NC}"
        echo ""
        echo "è¯·é€‰æ‹©æ“ä½œ:"
        echo "1. å¤‡ä»½å½“å‰é…ç½®"
        echo "2. åˆ—å‡ºå¤‡ä»½æ–‡ä»¶"
        echo "3. æ¢å¤é…ç½®"
        echo "4. æ˜¾ç¤ºå¸®åŠ©"
        echo ""
        read -p "è¯·é€‰æ‹© [1-4]: " choice
        
        case $choice in
            1)
                if check_disk_space; then
                    perform_backup
                fi
                ;;
            2)
                list_backups
                ;;
            3)
                list_backups
                echo ""
                read -p "è¯·è¾“å…¥è¦æ¢å¤çš„æ–‡ä»¶å: " file_name
                restore_backup "$file_name"
                ;;
            4)
                show_help
                ;;
            *)
                echo "æ— æ•ˆé€‰æ‹©"
                ;;
        esac
        ;;
esac

exit 0
EOF
chmod +x files/root/backup-config.sh

echo "é…ç½®å¤‡ä»½è„šæœ¬å®Œæˆ..."

# ====================================================
# 13. æ—¥å¿—è½®è½¬é…ç½®
# ====================================================

cat > files/etc/logrotate.d/custom << 'EOF'
# è‡ªå®šä¹‰æœåŠ¡æ—¥å¿—è½®è½¬é…ç½®
/var/log/custom/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # å¦‚æœæœ‰æœåŠ¡éœ€è¦é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å‘½ä»¤
        # ä¾‹å¦‚: kill -USR1 $(cat /var/run/custom-service.pid 2>/dev/null) 2>/dev/null || true
    endscript
}

# Dockeræ—¥å¿—è½®è½¬
/opt/docker/containers/*/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    size 10M
    create 644 root root
}
EOF

echo "æ—¥å¿—è½®è½¬é…ç½®å®Œæˆ..."

# ====================================================
# 14. æ·»åŠ ç³»ç»Ÿå¥åº·æ£€æŸ¥è„šæœ¬
# ====================================================

cat > files/root/health-check.sh << 'EOF'
#!/bin/bash

# ç³»ç»Ÿå¥åº·æ£€æŸ¥è„šæœ¬
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}=== R2C Plus ç³»ç»Ÿå¥åº·æ£€æŸ¥ ===${NC}"
echo "æ£€æŸ¥æ—¶é—´: $(date)"
echo ""

# æ£€æŸ¥å‡½æ•°
check_status() {
    if [ $1 -eq 0 ]; then
        echo -e "  ${GREEN}âœ“${NC} $2"
    else
        echo -e "  ${RED}âœ—${NC} $2"
    fi
}

# 1. ç³»ç»ŸåŸºæœ¬çŠ¶æ€
echo -e "${YELLOW}[1] ç³»ç»ŸåŸºæœ¬çŠ¶æ€${NC}"
uptime | awk '{print "  è¿è¡Œæ—¶é—´: " $3 " " $4}' | tr -d ','
check_status $? "ç³»ç»Ÿè¿è¡ŒçŠ¶æ€"

# 2. å†…å­˜ä½¿ç”¨
echo -e "${YELLOW}[2] å†…å­˜ä½¿ç”¨${NC}"
free -h | awk 'NR==2{print "  å†…å­˜ä½¿ç”¨: " $3 "/" $2 " (" $4 " å¯ç”¨)"}'
MEM_PERCENT=$(free | awk 'NR==2{printf "%d", $3*100/$2}')
if [ $MEM_PERCENT -gt 90 ]; then
    echo -e "  ${RED}è­¦å‘Š: å†…å­˜ä½¿ç”¨ç‡ ${MEM_PERCENT}%${NC}"
elif [ $MEM_PERCENT -gt 70 ]; then
    echo -e "  ${YELLOW}æ³¨æ„: å†…å­˜ä½¿ç”¨ç‡ ${MEM_PERCENT}%${NC}"
else
    echo -e "  ${GREEN}æ­£å¸¸: å†…å­˜ä½¿ç”¨ç‡ ${MEM_PERCENT}%${NC}"
fi

# 3. ç£ç›˜ä½¿ç”¨
echo -e "${YELLOW}[3] ç£ç›˜ä½¿ç”¨${NC}"
df -h / | awk 'NR==2{print "  æ ¹åˆ†åŒº: " $3 "/" $2 " (" $5 " å·²ç”¨)"}'
OVERLAY_USAGE=$(df -h /overlay 2>/dev/null | awk 'NR==2{print $5}' | tr -d '%')
if [ -n "$OVERLAY_USAGE" ]; then
    if [ $OVERLAY_USAGE -gt 90 ]; then
        echo -e "  ${RED}è­¦å‘Š: Overlayä½¿ç”¨ç‡ ${OVERLAY_USAGE}%${NC}"
    elif [ $OVERLAY_USAGE -gt 70 ]; then
        echo -e "  ${YELLOW}æ³¨æ„: Overlayä½¿ç”¨ç‡ ${OVERLAY_USAGE}%${NC}"
    else
        echo -e "  ${GREEN}æ­£å¸¸: Overlayä½¿ç”¨ç‡ ${OVERLAY_USAGE}%${NC}"
    fi
fi

# 4. CPUæ¸©åº¦
echo -e "${YELLOW}[4] CPUæ¸©åº¦${NC}"
if [ -f /sys/class/thermal/thermal_zone0/temp ]; then
    TEMP=$(cat /sys/class/thermal/thermal_zone0/temp)
    TEMP_C=$(echo "scale=1; $TEMP/1000" | bc)
    if [ $(echo "$TEMP_C > 80" | bc) -eq 1 ]; then
        echo -e "  ${RED}è­¦å‘Š: CPUæ¸©åº¦ ${TEMP_C}Â°C${NC}"
    elif [ $(echo "$TEMP_C > 70" | bc) -eq 1 ]; then
        echo -e "  ${YELLOW}æ³¨æ„: CPUæ¸©åº¦ ${TEMP_C}Â°C${NC}"
    else
        echo -e "  ${GREEN}æ­£å¸¸: CPUæ¸©åº¦ ${TEMP_C}Â°C${NC}"
    fi
else
    echo "  CPUæ¸©åº¦: æ— æ³•è·å–"
fi

# 5. ç½‘ç»œè¿æ¥
echo -e "${YELLOW}[5] ç½‘ç»œè¿æ¥${NC}"
CONN_COUNT=$(cat /proc/net/nf_conntrack 2>/dev/null | wc -l || ss -tun | wc -l)
echo "  æ´»åŠ¨è¿æ¥: $CONN_COUNT"
ping -c 1 114.114.114.114 >/dev/null 2>&1
if [ $? -eq 0 ]; then
    echo -e "  ${GREEN}å¤–ç½‘è¿æ¥: æ­£å¸¸${NC}"
else
    echo -e "  ${RED}å¤–ç½‘è¿æ¥: å¤±è´¥${NC}"
fi

# 6. æœåŠ¡çŠ¶æ€
echo -e "${YELLOW}[6] æœåŠ¡çŠ¶æ€${NC}"
SERVICES="network firewall dnsmasq dropbear uhttpd"
ALL_OK=1
for SERVICE in $SERVICES; do
    if /etc/init.d/$SERVICE enabled >/dev/null 2>&1; then
        if /etc/init.d/$SERVICE running >/dev/null 2>&1; then
            echo -e "  ${GREEN}âœ“${NC} $SERVICE: è¿è¡Œä¸­"
        else
            echo -e "  ${RED}âœ—${NC} $SERVICE: å·²åœæ­¢"
            ALL_OK=0
        fi
    else
        echo -e "  ${YELLOW}â—‹${NC} $SERVICE: æœªå¯ç”¨"
    fi
done

# 7. DockerçŠ¶æ€
echo -e "${YELLOW}[7] DockerçŠ¶æ€${NC}"
if command -v docker >/dev/null 2>&1; then
    if systemctl is-active docker >/dev/null 2>&1 || pgrep docker >/dev/null; then
        CONTAINERS=$(docker ps -q | wc -l)
        echo -e "  ${GREEN}âœ“${NC} Docker: è¿è¡Œä¸­ (${CONTAINERS}ä¸ªå®¹å™¨)"
        
        # æ£€æŸ¥å®¹å™¨çŠ¶æ€
        if [ $CONTAINERS -gt 0 ]; then
            echo "  å®¹å™¨çŠ¶æ€:"
            docker ps --format "    {{.Names}}: {{.Status}}" | while read line; do
                if echo "$line" | grep -q "Up"; then
                    echo -e "    ${GREEN}âœ“${NC} $line"
                else
                    echo -e "    ${RED}âœ—${NC} $line"
                fi
            done
        fi
    else
        echo -e "  ${RED}âœ—${NC} Docker: å·²åœæ­¢"
        ALL_OK=0
    fi
else
    echo "  Docker: æœªå®‰è£…"
fi

# 8. ç³»ç»Ÿè´Ÿè½½
echo -e "${YELLOW}[8] ç³»ç»Ÿè´Ÿè½½${NC}"
LOAD=$(uptime | awk -F'[a-z]:' '{print $2}' | xargs)
LOAD1=$(echo $LOAD | awk -F', ' '{print $1}')
LOAD5=$(echo $LOAD | awk -F', ' '{print $2}')
LOAD15=$(echo $LOAD | awk -F', ' '{print $3}')
echo "  æœ€è¿‘1åˆ†é’Ÿ: $LOAD1"
echo "  æœ€è¿‘5åˆ†é’Ÿ: $LOAD5"
echo "  æœ€è¿‘15åˆ†é’Ÿ: $LOAD15"

# æ€»ç»“
echo ""
echo -e "${BLUE}=== æ£€æŸ¥å®Œæˆ ===${NC}"
if [ $ALL_OK -eq 1 ]; then
    echo -e "${GREEN}âœ“ æ‰€æœ‰å…³é”®æœåŠ¡è¿è¡Œæ­£å¸¸${NC}"
else
    echo -e "${RED}âš  å‘ç°å¼‚å¸¸æœåŠ¡ï¼Œè¯·æ£€æŸ¥ä»¥ä¸Šæ ‡è®°ä¸ºâœ—çš„é¡¹ç›®${NC}"
fi
echo ""
echo "å»ºè®®æ“ä½œ:"
echo "  1. å®šæœŸè¿è¡Œ 'backup-config.sh' å¤‡ä»½é…ç½®"
echo "  2. ä½¿ç”¨ 'system_monitor.sh' å®æ—¶ç›‘æ§"
echo "  3. æ£€æŸ¥ '/var/log/messages' æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—"
echo ""
echo "å¿«é€Ÿå‘½ä»¤:"
echo "  system_monitor.sh    # å®æ—¶ç›‘æ§é¢æ¿"
echo "  backup-config.sh     # é…ç½®å¤‡ä»½"
echo "  health-check.sh      # å†æ¬¡è¿è¡Œå¥åº·æ£€æŸ¥"
EOF
chmod +x files/root/health-check.sh

echo "å¥åº·æ£€æŸ¥è„šæœ¬å®Œæˆ..."

# ====================================================
# 15. åˆ›å»ºç¼–è¯‘ä¿¡æ¯æ–‡ä»¶
# ====================================================

cat > files/etc/istoreos-build-info << 'EOF'
# iStoreOS for NanoPi R2C Plus æ„å»ºä¿¡æ¯
BUILD_DATE=$(date +%Y-%m-%d)
BUILD_VERSION="2.1"
BASE_SYSTEM="iStoreOS + FriendlyWrt 24.10"
TARGET_DEVICE="FriendlyARM NanoPi R2C Plus"
KERNEL_VERSION="6.6"
ARCHITECTURE="aarch64"
BUILD_FEATURES="Docker, iStoreX, Hardware Acceleration, BBR Optimized"
MAINTAINER="EZ-6086"
REPOSITORY="https://github.com/EZ-6086/istoreos-R2C-Plus"
EOF

# æ›´æ–°æ„å»ºæ—¥æœŸ
sed -i "s/BUILD_DATE=\$(date +%Y-%m-%d)/BUILD_DATE=$(date +%Y-%m-%d)/" files/etc/istoreos-build-info

echo "ç¼–è¯‘ä¿¡æ¯æ–‡ä»¶åˆ›å»ºå®Œæˆ..."

# ====================================================
# è„šæœ¬æ‰§è¡Œå®Œæˆ
# ====================================================

echo ""
echo "=========================================="
echo "è‡ªå®šä¹‰é…ç½®è„šæœ¬æ‰§è¡Œå®Œæˆï¼"
echo "=========================================="
echo ""
echo "å·²åˆ›å»ºä»¥ä¸‹é…ç½®ï¼š"
echo "  âœ“ ç½‘ç»œé…ç½® (é’ˆå¯¹R2C Plusä¼˜åŒ–)"
echo "  âœ“ å¢å¼ºé˜²ç«å¢™è§„åˆ™"
echo "  âœ“ ç³»ç»Ÿå¯åŠ¨é…ç½®"
echo "  âœ“ SSHæ¬¢è¿ä¿¡æ¯"
echo "  âœ“ æ€§èƒ½ç›‘æ§è„šæœ¬"
echo "  âœ“ å“åº”å¼Webé¡µé¢"
echo "  âœ“ æœåŠ¡ç®¡ç†è„šæœ¬"
echo "  âœ“ é¦–æ¬¡å¯åŠ¨é…ç½®"
echo "  âœ“ Overlayæ‰©å±•è„šæœ¬"
echo "  âœ“ é…ç½®å¤‡ä»½å·¥å…·"
echo "  âœ“ æ—¥å¿—è½®è½¬é…ç½®"
echo "  âœ“ ç³»ç»Ÿå¥åº·æ£€æŸ¥"
echo "  âœ“ æ„å»ºä¿¡æ¯æ–‡ä»¶"
echo ""
echo "ä¸‹ä¸€æ­¥ï¼š"
echo "  1. è¿è¡Œ make menuconfig æ£€æŸ¥é…ç½®"
echo "  2. æ‰§è¡Œ make -j$(nproc) å¼€å§‹ç¼–è¯‘"
echo "  3. é¦–æ¬¡å¯åŠ¨åè®¿é—® http://192.168.101.1"
echo ""
echo "æ³¨æ„ï¼šé¦–æ¬¡ç™»å½•è¯·ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç ï¼"

echo "=========================================="
