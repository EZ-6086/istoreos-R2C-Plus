name: Build iStoreOS for R2C Plus

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本号'
        required: false
        default: '$(date +%Y%m%d)'

env:
  DEVICE: nanopi-r2c-plus
  LAN_IP: 192.168.101.1
  LAN_NETMASK: 255.255.255.0
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: configs/r2cplus.config

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1

    - name: Set up environment and maximize disk space
      run: |
        sudo apt-get update
        # 安装编译依赖
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk gettext git java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev libssl-dev python3 python3-distutils python3-setuptools python3-dev python3-pip rsync subversion swig time xsltproc zlib1g-dev binutils bzip2 flex gcc-multilib g++-multilib gperf unzip libxml-parser-perl mercurial wget curl mc tree dos2unix
        
        # 安装Python依赖（解决pyelftools问题）
        python3 -m pip install --upgrade pip
        pip install pyelftools
        
        # 最大化磁盘空间[7](@ref)
        sudo rm -rf /usr/local/lib/android || true
        sudo rm -rf /usr/share/dotnet || true
        sudo rm -rf /opt/ghc || true
        sudo rm -rf /usr/local/share/boost || true
        sudo rm -rf /opt/az || true
        sudo rm -rf /usr/local/lib32 || true
        sudo apt-get clean
        docker system prune -af || true
        
        echo "CCACHE_DIR=$GITHUB_WORKSPACE/ccache" >> $GITHUB_ENV
        ccache -o max_size=5G
        
        echo "=== 磁盘空间使用情况 ==="
        df -h

    - name: Prepare toolchain
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Clone iStoreOS source with minimal depth
      run: |
        git clone https://github.com/istoreos/istoreos.git --depth=1 -b main
        cd istoreos
        git clone https://git.openwrt.org/openwrt/openwrt.git --depth=1 -b openwrt-24.10 openwrt
        cd openwrt

    - name: Configure feeds for OpenWrt 24.10 compatibility
      run: |
        cd istoreos/openwrt
        {
          echo 'src-git friendlywrt https://github.com/friendlyarm/friendlywrt.git;master-24.10'
          echo 'src-git istore https://github.com/istoreos/istore.git;main'
          echo 'src-git packages https://git.openwrt.org/feed/packages.git;openwrt-24.10'
          echo 'src-git luci https://git.openwrt.org/project/luci.git;openwrt-24.10'
          echo 'src-git routing https://git.openwrt.org/feed/routing.git;openwrt-24.10'
          echo 'src-git telephony https://git.openwrt.org/feed/telephony.git;openwrt-24.10'
        } > "$FEEDS_CONF"
        
        # 修复可能的行尾格式问题[8](@ref)
        find . -name "*.sh" -type f -exec dos2unix {} \; || true
        find . -name "*.patch" -type f -exec dos2unix {} \; || true

    - name: Update and install feeds
      run: |
        cd istoreos/openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        ./scripts/feeds install istore

    - name: Apply R2C Plus compatibility patches
      run: |
        cd istoreos/openwrt
        
        # 确保自定义脚本存在并可执行
        if [ -f "../../scripts/apply_patches.sh" ]; then
          chmod +x ../../scripts/apply_patches.sh
          dos2unix ../../scripts/apply_patches.sh
          ../../scripts/apply_patches.sh
        else
          # 基础补丁应用
          echo "应用基础R2C Plus设备支持..."
          # 添加设备定义到Makefile
          if ! grep -q "nanopi-r2c-plus" target/linux/rockchip/image/armv8.mk 2>/dev/null; then
            cat << 'EOF' >> target/linux/rockchip/image/armv8.mk

define Device/friendlyarm_nanopi-r2c-plus
  DEVICE_VENDOR := FriendlyARM
  DEVICE_MODEL := NanoPi R2C Plus
  SOC := rk3328
  UBOOT_DEVICE_NAME := nanopi-r2c-plus-rk3328
  IMAGE/sysupgrade.img.gz := boot-combined | boot-script nanopi-r2c-plus | sdcard-img | gzip | append-metadata
  DEVICE_PACKAGES := kmod-usb-net-rtl8152 kmod-r8169 kmod-ata-ahci kmod-usb-storage
endef
TARGET_DEVICES += friendlyarm_nanopi-r2c-plus
EOF
          fi
        fi

    - name: Copy configuration and set default IP
      run: |
        cd istoreos/openwrt
        cp ../../$CONFIG_FILE .config
        
        # 设置默认IP为192.168.101.1
        sed -i "s/CONFIG_TARGET_IP_ADDR=.*/CONFIG_TARGET_IP_ADDR=\"$LAN_IP\"/" .config
        sed -i "s/CONFIG_TARGET_NETMASK=.*/CONFIG_TARGET_NETMASK=\"$LAN_NETMASK\"/" .config
        
        make defconfig
        ./scripts/diffconfig.sh > diffconfig.log
        echo "=== 最终配置差异 ==="
        cat diffconfig.log | head -50

    - name: Download packages with retry logic
      run: |
        cd istoreos/openwrt
        echo "开始下载软件包..."
        
        # 多次重试下载[4](@ref)
        for i in {1..3}; do
          if make -j$(nproc) download; then
            echo "第$i次下载成功"
            break
          else
            echo "第$i次下载失败，重试..."
            sleep 10
          fi
        done
        
        # 最终验证
        make -j1 V=s download
        echo "下载完成"

    - name: Build firmware with optimized settings
      run: |
        cd istoreos/openwrt
        echo "开始编译固件，使用 $(($(nproc) - 1)) 线程..."
        
        # 使用稍少的线程数避免内存不足[6](@ref)
        make -j$(($(nproc) - 1)) V=s 2>&1 | tee build.log || {
          echo "多线程编译失败，尝试单线程编译..."
          make -j1 V=s 2>&1 | tee build-single.log
        }
        
        echo "编译过程完成"

    - name: Collect and prepare artifacts
      if: success()
      run: |
        cd istoreos/openwrt
        mkdir -p ../../artifacts
        
        # 查找并复制生成的固件
        find bin/targets -type f \( -name "*.img*" -o -name "*.bin*" -o -name "*.gz*" \) -exec cp {} ../../artifacts/ \;
        
        # 复制日志文件
        cp .config ../../artifacts/final-config 2>/dev/null || true
        cp build.log ../../artifacts/ 2>/dev/null || true
        cp build-single.log ../../artifacts/ 2>/dev/null || true
        cp diffconfig.log ../../artifacts/ 2>/dev/null || true
        
        # 创建构建信息文件
        {
          echo "Build date: $(date)"
          echo "Git commit: $GITHUB_SHA"
          echo "Device: $DEVICE"
          echo "LAN IP: $LAN_IP"
          echo "OpenWrt version: 24.10"
          echo "iStoreOS branch: main"
          echo "FriendlyWrt branch: master-24.10"
        } > ../../artifacts/build-info.txt
        
        echo "=== 生成的固件文件 ==="
        ls -la ../../artifacts/

    - name: Upload firmware artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.DEVICE }}-firmware-${{ github.run_id }}
        path: |
          artifacts/*
        retention-days: 30
        if-no-files-found: error

    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_id }}
        path: |
          istoreos/openwrt/build.log
          istoreos/openwrt/build-single.log
          istoreos/openwrt/diffconfig.log
        retention-days: 7
