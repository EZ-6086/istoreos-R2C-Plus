name: Build iStoreOS for R2C Plus (Stable)

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本号'
        required: false
        default: '$(date +%Y%m%d)'

env:
  DEVICE: nanopi-r2c-plus
  LAN_IP: 192.168.101.1
  LAN_NETMASK: 255.255.255.0
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: configs/r2cplus.config

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300 # 延长超时时间

    steps:
    # 第一步：检出代码
    - name: Checkout repository
      uses: actions/checkout@v4 # 使用最新稳定版Action[2,5](@ref)
      with:
        submodules: recursive
        fetch-depth: 1

    # 第二步：初始磁盘清理（关键步骤）
    - name: Initial disk space cleanup
      run: |
        echo "初始磁盘空间:"
        df -h
        echo "开始清理系统..."
        sudo apt-get clean
        sudo rm -rf /usr/local/lib/android \
                    /usr/share/dotnet \
                    /opt/ghc \
                    /opt/hostedtoolcache/CodeQL \
                    /usr/local/lib/android \
                    /opt/pipx
        sudo rm -rf /var/lib/apt/lists/*
        docker system prune -af || true
        echo "清理后磁盘空间:"
        df -h

    # 第三步：安装核心依赖
    - name: Install core dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache file gawk gettext git \
          libncurses5-dev libncursesw5-dev libssl-dev python3 \
          python3-pip subversion unzip wget curl zlib1g-dev
        pip install pyelftools

    # 第四步：克隆源码（带重试机制）
    - name: Clone source code with retry
      run: |
        for i in {1..3}; do
          if git clone --depth=1 -b main https://github.com/istoreos/istoreos.git && \
             cd istoreos && \
             git clone --depth=1 -b openwrt-24.10 https://git.openwrt.org/openwrt/openwrt.git openwrt; then
            echo "源码克隆成功 (尝试 $i)"
            break
          else
            echo "克隆失败，重试 $i/3..."
            rm -rf istoreos
            sleep 30
          fi
        done

    # 第五步：配置Feeds（修复网络问题）
    - name: Configure feeds with stability
      run: |
        cd istoreos/openwrt
        # 使用稳定的feed配置
        cat > "$FEEDS_CONF" << 'EOF'
src-git friendlywrt https://github.com/friendlyarm/friendlywrt.git;master-v24.10
src-git istore https://github.com/linkease/istore.git;main
src-git packages https://git.openwrt.org/feed/packages.git;openwrt-24.10
src-git luci https://git.openwrt.org/project/luci.git;openwrt-24.10
src-git routing https://git.openwrt.org/feed/routing.git;openwrt-24.10
EOF

    # 第六步：更新Feeds（分步进行，增强稳定性）
    - name: Update feeds step by step
      run: |
        cd istoreos/openwrt
        # 分步更新，避免单点失败影响全部[6](@ref)
        for feed in luci packages routing telephony; do
          for i in {1..3}; do
            echo "更新 $feed feed (尝试 $i/3)"
            if ./scripts/feeds update $feed; then
              echo "$feed 更新成功"
              break
            elif [ $i -eq 3 ]; then
              echo "错误: $feed 更新失败"
              exit 1
            else
              sleep 30
            fi
          done
        done

    # 第七步：安装Feeds
    - name: Install all feeds
      run: |
        cd istoreos/openwrt
        ./scripts/feeds install -a

    # 第八步：应用基础补丁
    - name: Apply basic device patches
      run: |
        cd istoreos/openwrt
        # 确保设备定义存在
        if ! grep -q "nanopi-r2c-plus" target/linux/rockchip/image/armv8.mk; then
          cat >> target/linux/rockchip/image/armv8.mk << 'EOF'

define Device/friendlyarm_nanopi-r2c-plus
  DEVICE_VENDOR := FriendlyARM
  DEVICE_MODEL := NanoPi R2C Plus
  SOC := rk3328
  IMAGE/sysupgrade.img.gz := boot-combined | boot-script nanopi-r2c-plus | sdcard-img | gzip | append-metadata
  DEVICE_PACKAGES := kmod-usb-net-rtl8152 kmod-r8169
endef
TARGET_DEVICES += friendlyarm_nanopi-r2c-plus
EOF
        fi

    # 第九步：复制配置文件
    - name: Copy configuration file
      run: |
        cd istoreos/openwrt
        [ -f "../../$CONFIG_FILE" ] && cp "../../$CONFIG_FILE" .config
        # 设置默认IP
        sed -i "s/CONFIG_TARGET_IP_ADDR=.*/CONFIG_TARGET_IP_ADDR=\"$LAN_IP\"/" .config
        sed -i "s/CONFIG_TARGET_NETMASK=.*/CONFIG_TARGET_NETMASK=\"$LAN_NETMASK\"/" .config
        make defconfig

    # 第十步：下载软件包（带重试）
    - name: Download packages with retry
      run: |
        cd istoreos/openwrt
        for i in {1..3}; do
          if make -j2 download; then
            echo "包下载成功"
            break
          elif [ $i -eq 3 ]; then
            echo "错误: 包下载失败"
            exit 1
          else
            echo "包下载失败，重试 $i/3..."
            sleep 60
          fi
        done

    # 第十一步：最终磁盘清理
    - name: Final disk cleanup before build
      run: |
        echo "编译前最终磁盘空间:"
        df -h
        sudo apt-get autoremove -y
        sudo apt-get clean

    # 第十二步：编译固件（单线程稳定模式）
    - name: Build firmware (single thread for stability)
      run: |
        cd istoreos/openwrt
        # 使用单线程编译避免内存和磁盘压力[6](@ref)
        make -j1 V=s 2>&1 | tee build.log

    # 第十三步：收集构建产物
    - name: Collect build artifacts
      if: success()
      run: |
        cd istoreos/openwrt
        mkdir -p ../../artifacts
        # 查找固件文件
        find bin/targets -type f \( -name "*.img" -o -name "*.bin" -o -name "*.gz" \) -exec cp {} ../../artifacts/ \;
        # 保存构建日志
        cp build.log ../../artifacts/ 2>/dev/null || true
        echo "构建产物:"
        ls -la ../../artifacts/

    # 第十四步：上传产物
    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.DEVICE }}-firmware-${{ github.run_id }}
        path: artifacts/*
        retention-days: 7

    # 第十五步：失败时收集诊断信息
    - name: Collect diagnostics on failure
      if: failure()
      run: |
        cd istoreos/openwrt
        echo "=== 编译失败诊断 ==="
        # 检查磁盘空间
        df -h
        # 检查关键错误
        tail -200 build.log 2>/dev/null || echo "无构建日志"
        # 查找Makefile错误
        find logs -name "dump.txt" -exec echo "=== {} ===" \; -exec head -50 {} \; 2>/dev/null || true
