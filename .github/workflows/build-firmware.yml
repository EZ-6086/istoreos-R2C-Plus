# ====================================================
# iStoreOS for NanoPi R2C Plus GitHub Actions 配置
# 版本: 2.1
# 更新日期: $(date +%Y-%m-%d)
# 描述: GitHub Actions 运行
# ====================================================

name: Build iStoreOS for R2C Plus (Stable)

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - '**/README.md'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本号'
        required: false
        default: '$(date +%Y%m%d)'
      build_type:
        description: '构建类型'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - minimal
          - docker

env:
  DEVICE: nanopi-r2c-plus
  LAN_IP: 192.168.101.1
  LAN_NETMASK: 255.255.255.0
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: configs/r2cplus.config

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    strategy:
      matrix:
        type: ['full']
    
    steps:
      # 第一步：检出代码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1
          lfs: false

      # 第二步：设置构建缓存
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.ccache
            ./istoreos/openwrt/dl
            ./istoreos/openwrt/build_dir
          key: ${{ runner.os }}-build-${{ hashFiles('configs/r2cplus.config', 'configs/common.config') }}
          restore-keys: |
            ${{ runner.os }}-build-

      # 第三步：初始磁盘清理
      - name: Initial disk space cleanup
        run: |
          echo "初始磁盘空间:"
          df -h
          
          # 清理系统包缓存
          sudo apt-get clean
          sudo apt-get autoremove -y
          
          # 清理Docker
          docker system prune -af 2>/dev/null || true
          
          # 清理临时文件
          sudo rm -rf /tmp/* /var/tmp/*
          
          echo "清理后磁盘空间:"
          df -h

      # 第四步：安装核心依赖
      - name: Install core dependencies
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential ccache ecj fastjar file g++ gawk \
            gettext git java-propose-classpath libelf-dev libncurses5-dev \
            libncursesw5-dev libssl-dev python3 python3-pip python3-setuptools \
            python3-dev python3-venv rsync subversion swig time unzip wget \
            xsltproc zlib1g-dev cpio curl gcc-multilib gperf libxml-parser-perl \
            ocaml-nox sharutils texinfo yui-compressor upx-ucl cmake pkg-config \
            automake autoconf libtool flex bison gcc g++ make patch perl \
            libjson-perl libxml-simple-perl libfile-slurp-perl
          
          # 安装Python依赖
          pip install pyelftools
          
          # 配置ccache
          ccache -M 2G
          ccache -s

      # 第五步：准备源码目录
      - name: Prepare source directory
        run: |
          mkdir -p istoreos
          cd istoreos

      # 第六步：克隆源码（优化版）
      - name: Clone source code with retry
        run: |
          echo "开始克隆源码..."
          
          # 创建目录
          mkdir -p istoreos
          cd istoreos
          
          echo "克隆 iStoreOS..."
          if ! git clone --depth=1 -b main https://github.com/istoreos/istoreos.git .; then
            echo "错误: iStoreOS 克隆失败"
            exit 1
          fi
          
          echo "iStoreOS 克隆成功，目录内容:"
          ls -la
          
          echo "克隆 OpenWrt..."
          if ! git clone --depth=1 -b openwrt-24.10 https://git.openwrt.org/openwrt/openwrt.git openwrt; then
            # 尝试备用源
            echo "主源失败，尝试 GitHub 镜像..."
            if ! git clone --depth=1 -b v24.10.x https://github.com/openwrt/openwrt.git openwrt; then
              echo "错误: OpenWrt 克隆失败"
              exit 1
            fi
          fi
          
          echo "OpenWrt 克隆成功"
          echo "最终目录结构:"
          pwd
          ls -la
          echo "openwrt 目录:"
          ls -la openwrt/
          
        working-directory: ./
        
      # 第七步：配置Feeds
      - name: Configure feeds
        run: |
          cat > "$FEEDS_CONF" << 'EOF'
          src-git friendlywrt https://github.com/friendlyarm/friendlywrt.git;master-v24.10
          src-git istore https://github.com/linkease/istore.git;main
          src-git packages https://git.openwrt.org/feed/packages.git;openwrt-24.10
          src-git luci https://git.openwrt.org/project/luci.git;openwrt-24.10
          src-git routing https://git.openwrt.org/feed/routing.git;openwrt-24.10
          src-git telephony https://git.openwrt.org/feed/telephony.git;openwrt-24.10
          EOF
        working-directory: ./istoreos/openwrt

      # 第八步：更新Feeds
      - name: Update feeds
        run: |
          ./scripts/feeds update -a
        working-directory: ./istoreos/openwrt

      # 第九步：安装Feeds
      - name: Install feeds
        run: |
          ./scripts/feeds install -a
        working-directory: ./istoreos/openwrt
        
      # 第九步半：修复脚本换行符
      - name: Fix script line endings
        run: |
          if [ -d "$GITHUB_WORKSPACE/scripts" ]; then
            # 安装 dos2unix 或使用 sed 修复换行符
            sudo apt-get update
            sudo apt-get install -y dos2unix
            # 修复所有脚本文件的换行符
            find "$GITHUB_WORKSPACE/scripts" -name "*.sh" -exec dos2unix {} \;
            # 确保脚本有执行权限
            find "$GITHUB_WORKSPACE/scripts" -name "*.sh" -exec chmod +x {} \;
          fi    

      # 第十步：应用补丁
      - name: Apply patches
        run: |
          if [ -f "$GITHUB_WORKSPACE/scripts/apply_patches.sh" ]; then
            chmod +x "$GITHUB_WORKSPACE/scripts/apply_patches.sh"
            "$GITHUB_WORKSPACE/scripts/apply_patches.sh"
          fi
        working-directory: ./istoreos/openwrt

      # 第十一步：应用自定义配置
      - name: Apply custom configuration
        run: |
          if [ -f "$GITHUB_WORKSPACE/scripts/custom_scripts.sh" ]; then
            chmod +x "$GITHUB_WORKSPACE/scripts/custom_scripts.sh"
            "$GITHUB_WORKSPACE/scripts/custom_scripts.sh"
          fi
        working-directory: ./istoreos/openwrt

      # 第十二步：复制配置文件
      - name: Copy configuration file
        run: |
          if [ -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
            echo "使用自定义配置文件: $CONFIG_FILE"
            cp "$GITHUB_WORKSPACE/$CONFIG_FILE" .config
          else
            echo "错误: 配置文件不存在"
            exit 1
          fi
          
          # 设置环境变量
          sed -i "s|CONFIG_TARGET_IP_ADDR=.*|CONFIG_TARGET_IP_ADDR=\"$LAN_IP\"|" .config 2>/dev/null || true
          sed -i "s|CONFIG_TARGET_NETMASK=.*|CONFIG_TARGET_NETMASK=\"$LAN_NETMASK\"|" .config 2>/dev/null || true
          
          # 应用配置
          make defconfig
        working-directory: ./istoreos/openwrt

      # 第十三步：下载软件包
      - name: Download packages
        run: |
          for i in {1..3}; do
            if make download -j$(nproc); then
              echo "包下载成功"
              break
            elif [ $i -eq 3 ]; then
              echo "警告: 包下载失败，继续构建..."
            else
              echo "包下载失败，60秒后重试..."
              sleep 60
            fi
          done
        working-directory: ./istoreos/openwrt

      # 第十三步半：编译前验证
      - name: Pre-build verification
        run: |
          echo "=== 编译前状态检查 ==="
          echo "当前目录: $(pwd)"
          echo "工作空间: $GITHUB_WORKSPACE"
          echo "检查目录结构..."
          
          # 检查目录是否存在
          if [ -d "istoreos/openwrt" ]; then
            echo "✓ istoreos/openwrt 目录存在"
            echo "目录内容:"
            ls -la istoreos/openwrt/ | head -10
          else
            echo "✗ istoreos/openwrt 目录不存在"
            echo "当前目录结构:"
            find . -maxdepth 3 -type d | sort
            exit 1
          fi
          
          # 检查配置文件
          if [ -f "istoreos/openwrt/.config" ]; then
            echo "✓ .config 文件存在"
          else
            echo "警告: .config 文件不存在，将使用默认配置"
          fi
          
          echo "磁盘空间:"
          df -h
          
          echo "=== 验证完成 ==="

          echo "=== 编译前优化 ==="
          
          # 最大化清理系统
          echo "1. 清理系统缓存..."
          sudo apt-get clean
          sudo apt-get autoremove -y --purge
          sudo rm -rf /var/lib/apt/lists/*
          
          echo "2. 清理各种缓存..."
          # Docker
          docker system prune -af 2>/dev/null || true
          # NPM
          npm cache clean --force 2>/dev/null || true
          # Pip
          python3 -m pip cache purge 2>/dev/null || true
          # Ruby gems
          gem cleanup 2>/dev/null || true
          # Maven
          rm -rf ~/.m2/repository 2>/dev/null || true
          
          echo "3. 清理临时文件..."
          sudo rm -rf /tmp/* /var/tmp/*
          sudo rm -rf /home/runner/.cache/* 2>/dev/null || true
          
          echo "4. 优化 ccache 设置..."
          ccache -C  # 清除缓存
          ccache -M 500M  # 限制为 500MB
          
          echo "当前磁盘空间:"
          df -h
          
          echo "=== 优化完成 ==="
          


      # 第十四步：编译固件（优化完整版）
      - name: Build firmware (optimized)
        run: |
          cd "$GITHUB_WORKSPACE/istoreos/openwrt"
          
          echo "=== 编译环境 ==="
          echo "目录: $(pwd)"
          echo "磁盘空间:"
          df -h
          
          # 非常保守的线程设置
          BUILD_JOBS=1
          echo "使用线程数: $BUILD_JOBS"
          
          # 分阶段编译，每阶段后清理
          STAGES=("tools/compile" "toolchain/compile" "target/compile")
          
          for stage in "${STAGES[@]}"; do
            echo "编译阶段: $stage"
            
            # 编译当前阶段
            time make -j$BUILD_JOBS $stage 2>&1 | tail -100
            
            # 阶段后清理
            echo "阶段后清理..."
            make clean-staging 2>/dev/null || true
            make clean-tmp 2>/dev/null || true
            
            # 清理大文件
            find dl -type f -size +20M -delete 2>/dev/null || true
            find build_dir -name "*.o" -type f -delete 2>/dev/null || true
            
            echo "当前磁盘空间:"
            df -h
            
            # 如果磁盘空间不足，采取紧急措施
            AVAIL=$(df --output=avail / | tail -1)
            if [ $AVAIL -lt 1000000 ]; then  # 小于 1GB
              echo "警告: 磁盘空间不足，紧急清理..."
              make clean 2>/dev/null || true
              rm -rf tmp build_dir/target-* 2>/dev/null || true
            fi
          done
          
          echo "最终编译..."
          # 使用最小化输出
          time make -j$BUILD_JOBS 2>&1 | grep -E "(error|Error|installing|Collecting)" | tail -500 > build.log
          
          # 检查结果
          if find bin -name "*.img" -o -name "*.bin" -o -name "*.gz" 2>/dev/null | grep -q .; then
            echo "编译成功！找到固件:"
            find bin -name "*.img" -o -name "*.bin" -o -name "*.gz" 2>/dev/null | head -5
          else
            echo "编译失败！最后错误:"
            tail -50 build.log
            exit 1
          fi
          
          echo "最终磁盘空间:"
          df -h

      # 第十五步：后处理
      - name: Post-build processing
        if: success()
        run: |
          if [ -f "$GITHUB_WORKSPACE/scripts/post_build.sh" ]; then
            chmod +x "$GITHUB_WORKSPACE/scripts/post_build.sh"
            "$GITHUB_WORKSPACE/scripts/post_build.sh" "./istoreos/openwrt" "$GITHUB_WORKSPACE/artifacts"
          else
            # 默认收集固件
            mkdir -p $GITHUB_WORKSPACE/artifacts
            cd ./istoreos/openwrt
            
            # 查找固件文件
            find bin/targets -type f \( -name "*.img" -o -name "*.bin" -o -name "*.gz" \) -exec cp {} $GITHUB_WORKSPACE/artifacts/ \;
            
            # 收集日志
            cp build.log $GITHUB_WORKSPACE/artifacts/ 2>/dev/null || true
            cp .config $GITHUB_WORKSPACE/artifacts/ 2>/dev/null || true
          fi
          
          echo "构建产物:"
          ls -la $GITHUB_WORKSPACE/artifacts/

      # 第十六步：上传产物
      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE }}-firmware-${{ github.run_number }}
          path: |
            artifacts/*
          retention-days: 30
          if-no-files-found: error

      # 第十七步：失败诊断
      - name: Diagnostics on failure
        if: failure()
        run: |
          echo "=== 编译失败诊断 ==="
          echo "磁盘空间:"
          df -h
          echo "内存使用:"
          free -h
          
          if [ -f ./istoreos/openwrt/build.log ]; then
            echo "构建日志最后100行:"
            tail -100 ./istoreos/openwrt/build.log
          fi
