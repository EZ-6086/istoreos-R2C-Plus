# ====================================================
# iStoreOS for NanoPi R2C Plus GitHub Actions 配置
# 版本: 3.1 - 磁盘空间优化版
# 更新日期: $(date +%Y-%m-%d)
# 描述: 优化版 GitHub Actions 工作流，最大化利用磁盘空间
# ====================================================

name: Build iStoreOS for R2C Plus (Space Optimized)

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - '**/README.md'
      - '.gitignore'
      - '.gitattributes'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本号'
        required: false
        default: '$(date +%Y%m%d)'
      build_type:
        description: '构建类型'
        required: false
        default: 'minimal'
        type: choice
        options:
          - minimal
          - full
          - docker
      clean_build:
        description: '是否清理缓存重新构建'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  DEVICE: nanopi-r2c-plus
  LAN_IP: 192.168.101.1
  LAN_NETMASK: 255.255.255.0
  WORKSPACE_PATH: /home/runner/istoreos-build
  CACHE_PATH: /home/runner/openwrt-cache
  BUILD_TYPE: ${{ github.event.inputs.build_type || 'minimal' }}

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240  # 减少超时时间
    strategy:
      matrix:
        type: ['${{ env.BUILD_TYPE }}']
    
    steps:
      # 第一步：初始磁盘空间检查和优化
      - name: Initial disk space check and optimization
        run: |
          echo "=== 初始磁盘空间状态 ==="
          df -h
          echo "内存状态:"
          free -h
          echo "========================="
          
          # 清理系统缓存
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo rm -rf /tmp/* /var/tmp/*
          
          # 创建工作目录
          echo "创建工作目录: ${{ env.WORKSPACE_PATH }}"
          mkdir -p ${{ env.WORKSPACE_PATH }}
          mkdir -p ${{ env.CACHE_PATH }}
          
          # 设置权限
          sudo chmod -R 777 ${{ env.WORKSPACE_PATH }} || true
          
          echo "初始工作空间大小:"
          du -sh ${{ env.WORKSPACE_PATH }}

      # 第二步：检出代码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1
          lfs: false

      # 第三步：将源码复制到自定义工作空间
      - name: Copy source to custom workspace
        run: |
          echo "复制源码到自定义工作空间: ${{ env.WORKSPACE_PATH }}"
          rsync -av --exclude='.git' --exclude='.github' ${{ github.workspace }}/ ${{ env.WORKSPACE_PATH }}/
          echo "复制完成"
          ls -la ${{ env.WORKSPACE_PATH }}/

      # 第四步：设置构建缓存（只缓存dl目录）
      - name: Cache OpenWrt downloads
        uses: actions/cache@v3
        with:
          path: ${{ env.CACHE_PATH }}/dl
          key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('configs/r2cplus*.config') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-dl-

      # 第五步：修复脚本权限
      - name: Fix script permissions
        run: |
          echo "修复脚本权限..."
          find "${{ env.WORKSPACE_PATH }}/scripts" -name "*.sh" -type f -exec chmod +x {} \; 2>/dev/null || true
          find "${{ env.WORKSPACE_PATH }}" -name "*.sh" -type f -exec sed -i 's/\r$//' {} \; 2>/dev/null || true
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第六步：最小化依赖安装
      - name: Install minimal dependencies
        run: |
          echo "=== 安装最小化依赖 ==="
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential ccache ecj fastjar file g++ gawk \
            gettext git java-propose-classpath libelf-dev libncurses5-dev \
            libncursesw5-dev libssl-dev python3 python3-pip python3-setuptools \
            rsync subversion swig time unzip wget \
            xsltproc zlib1g-dev cpio curl gperf libxml-parser-perl \
            ocaml-nox sharutils texinfo upx-ucl cmake pkg-config \
            automake autoconf libtool flex bison gcc g++ make patch perl \
            dos2unix
          echo "安装后磁盘空间:"
          df -h

      # 第七步：准备源码目录结构
      - name: Prepare source directory structure
        run: |
          echo "准备源码目录结构..."
          mkdir -p istoreos
          cd istoreos
          echo "当前目录: $(pwd)"
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第八步：克隆 iStoreOS 源码（优化版）
      - name: Clone iStoreOS source (optimized)
        run: |
          echo "克隆 iStoreOS 源码..."
          cd istoreos
          
          # 使用更快的克隆方式
          git init
          git remote add origin https://github.com/istoreos/istoreos.git
          git config core.compression 0
          git fetch --depth=1 origin main
          git checkout FETCH_HEAD
          
          echo "克隆完成，目录内容:"
          ls -la
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第九步：克隆 OpenWrt 源码（优化版）
      - name: Clone OpenWrt source (optimized)
        run: |
          echo "克隆 OpenWrt 源码..."
          cd istoreos
          
          # 创建openwrt目录并初始化
          mkdir -p openwrt
          cd openwrt
          git init
          git remote add origin https://github.com/openwrt/openwrt.git
          git config core.compression 0
          git fetch --depth=1 origin openwrt-24.10
          git checkout FETCH_HEAD
          
          echo "验证 OpenWrt 目录:"
          ls -la
          echo "当前磁盘空间:"
          df -h
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十步：链接缓存目录
      - name: Link cache directories
        run: |
          echo "链接缓存目录..."
          cd istoreos/openwrt
          
          # 只链接dl目录
          mkdir -p ${{ env.CACHE_PATH }}/dl
          rm -rf dl 2>/dev/null || true
          ln -sf ${{ env.CACHE_PATH }}/dl dl
          
          echo "缓存目录链接完成"
          ls -la | grep -E "^l.*dl"
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十一步：配置 Feeds（精简版）
      - name: Configure feeds (minimal)
        run: |
          echo "配置 feeds..."
          cd istoreos/openwrt
          
          # 使用精简的feeds配置
          cat > "feeds.conf" << 'EOF'
          src-git friendlywrt https://github.com/friendlyarm/friendlywrt.git;master-v24.10
          src-git istore https://github.com/linkease/istore.git;main
          src-git packages https://git.openwrt.org/feed/packages.git;openwrt-24.10
          src-git luci https://git.openwrt.org/project/luci.git;openwrt-24.10
          EOF
          
          cat feeds.conf
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十二步：更新和安装 Feeds（选择性）
      - name: Update and install feeds selectively
        run: |
          echo "更新和安装 feeds..."
          cd istoreos/openwrt
          
          # 只更新必要的feeds
          ./scripts/feeds update -a
          
          # 根据构建类型安装不同的feeds
          if [ "${{ env.BUILD_TYPE }}" = "minimal" ]; then
            echo "最小化安装: 只安装基础包"
            ./scripts/feeds install -a -p packages
            ./scripts/feeds install -a -p luci
          else
            ./scripts/feeds install -a
          fi
          
          echo "feeds 安装完成"
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十三步：应用补丁
      - name: Apply patches
        run: |
          echo "应用补丁..."
          cd istoreos/openwrt
          if [ -f "../../scripts/apply_patches.sh" ]; then
            chmod +x "../../scripts/apply_patches.sh"
            "../../scripts/apply_patches.sh"
          else
            echo "没有找到补丁脚本，跳过"
          fi
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十四步：应用自定义脚本
      - name: Apply custom scripts
        run: |
          echo "应用自定义脚本..."
          cd istoreos/openwrt
          if [ -f "../../scripts/custom_scripts.sh" ]; then
            chmod +x "../../scripts/custom_scripts.sh"
            "../../scripts/custom_scripts.sh"
          else
            echo "没有找到自定义脚本，跳过"
          fi
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十五步：复制和配置配置文件（优化版）
      - name: Copy and configure config file (optimized)
        run: |
          echo "复制和配置配置文件..."
          cd istoreos/openwrt
          
          # 根据构建类型选择配置文件
          if [ "${{ env.BUILD_TYPE }}" = "minimal" ]; then
            echo "使用精简版配置文件..."
            CONFIG_FILE="../../configs/r2cplus-minimal.config"
          else
            echo "使用完整版配置文件..."
            CONFIG_FILE="../../configs/r2cplus.config"
          fi
          
          if [ -f "$CONFIG_FILE" ]; then
            echo "使用配置文件: $CONFIG_FILE"
            cp "$CONFIG_FILE" .config
            
            # 强制禁用大型包以节省空间
            echo "# 强制禁用以节省磁盘空间" >> .config
            echo "# CONFIG_PACKAGE_dockerd is not set" >> .config
            echo "# CONFIG_PACKAGE_docker-compose is not set" >> .config
            echo "# CONFIG_PACKAGE_python3 is not set" >> .config
            echo "# CONFIG_PACKAGE_python3-pip is not set" >> .config
            echo "# CONFIG_PACKAGE_node is not set" >> .config
            echo "# CONFIG_PACKAGE_git is not set" >> .config
            echo "# CONFIG_PACKAGE_golang is not set" >> .config
            echo "# CONFIG_PACKAGE_samba4-server is not set" >> .config
            echo "# CONFIG_PACKAGE_cups is not set" >> .config
            
          else
            echo "错误: 配置文件不存在: $CONFIG_FILE"
            exit 1
          fi
          
          # 应用网络配置
          sed -i "s|CONFIG_TARGET_IP_ADDR=.*|CONFIG_TARGET_IP_ADDR=\"$LAN_IP\"|" .config 2>/dev/null || true
          sed -i "s|CONFIG_TARGET_NETMASK=.*|CONFIG_TARGET_NETMASK=\"$LAN_NETMASK\"|" .config 2>/dev/null || true
          
          # 生成默认配置
          make defconfig
          
          echo "配置文件摘要:"
          grep -E "CONFIG_TARGET|CONFIG_ARCH|CONFIG_PACKAGE" .config | head -20
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十六步：下载软件包（优化版）
      - name: Download packages (optimized)
        run: |
          echo "下载软件包..."
          cd istoreos/openwrt
          echo "下载前磁盘空间:"
          df -h
          
          # 限制并发下载以减少内存使用
          for i in {1..3}; do
            echo "下载尝试 $i/3..."
            if make download -j2; then
              echo "包下载成功"
              break
            elif [ $i -eq 3 ]; then
              echo "警告: 包下载失败，尝试继续构建..."
            else
              sleep 30
            fi
          done
          
          # 清理下载缓存
          find dl -name "*.tar.gz" -size +50M -delete 2>/dev/null || true
          
          echo "下载后磁盘空间:"
          df -h
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十七步：额外磁盘清理
      - name: Extra disk cleanup
        run: |
          echo "进行额外磁盘清理..."
          
          # 清理APT缓存
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          
          # 清理内核源码
          if [ -d "${{ env.WORKSPACE_PATH }}/istoreos/openwrt/build_dir" ]; then
            echo "清理build_dir中的大型文件..."
            find "${{ env.WORKSPACE_PATH }}/istoreos/openwrt/build_dir" -name "*.tar.gz" -type f -size +10M -delete 2>/dev/null || true
            find "${{ env.WORKSPACE_PATH }}/istoreos/openwrt/build_dir" -name "*.tar.xz" -type f -size +10M -delete 2>/dev/null || true
            find "${{ env.WORKSPACE_PATH }}/istoreos/openwrt/build_dir" -name "*.zip" -type f -size +10M -delete 2>/dev/null || true
          fi
          
          # 清理临时文件
          sudo rm -rf /tmp/* /var/tmp/*
          
          echo "清理后磁盘空间:"
          df -h

      # 第十八步：编译固件（极简优化版）
      - name: Build firmware (minimal optimized)
        run: |
          echo "=== 编译固件开始（极简优化版） ==="
          cd istoreos/openwrt
          
          # 禁用所有缓存以节省空间
          unset CCACHE_DIR
          unset CCACHE_DISABLE
          
          # 使用保守的编译线程数
          CPU_CORES=$(nproc)
          BUILD_JOBS=$((CPU_CORES > 2 ? CPU_CORES - 2 : 2))
          echo "使用编译线程数: $BUILD_JOBS"
          
          echo "编译前磁盘空间:"
          df -h
          
          # 分步编译，每步后清理
          echo "阶段1: 编译工具链..."
          time make tools/compile -j$BUILD_JOBS 2>&1 | tail -30
          
          echo "清理工具链中间文件..."
          find build_dir -name "*.o" -type f -delete 2>/dev/null || true
          
          echo "阶段2: 编译工具..."
          time make toolchain/compile -j$BUILD_JOBS 2>&1 | tail -30
          
          echo "清理工具中间文件..."
          find build_dir -name "*.a" -type f -delete 2>/dev/null || true
          
          echo "阶段3: 编译目标..."
          time make target/compile -j$BUILD_JOBS 2>&1 | tail -30
          
          echo "清理目标中间文件..."
          find build_dir/target-* -name "*.o" -type f -delete 2>/dev/null || true
          
          echo "阶段4: 编译包（分批次）..."
          # 分三批次编译包
          for batch in 1 2 3; do
            echo "批次 $batch/3: 编译包..."
            time make package/compile -j$BUILD_JOBS 2>&1 | tail -30
            
            if [ $batch -lt 3 ]; then
              echo "清理批次 $batch 中间文件..."
              find build_dir -name "*.o" -type f -delete 2>/dev/null || true
              sleep 2
            fi
          done
          
          echo "最终链接..."
          time make -j$BUILD_JOBS 2>&1 | tee build.log | grep -E "(error|Error|installing|Compiling|Linking)" | tail -200
          
          # 清理最终中间文件
          echo "清理最终中间文件..."
          find build_dir -name "*.o" -type f -delete 2>/dev/null || true
          find build_dir -name "*.a" -type f -delete 2>/dev/null || true
          
          COMPILE_RESULT=$?
          if [ $COMPILE_RESULT -eq 0 ]; then
            echo "编译成功!"
            find bin/targets -name "*.img" -o -name "*.bin" -o -name "*.gz" 2>/dev/null | xargs ls -lh
          else
            echo "编译失败!"
            tail -100 build.log | grep -i error
            exit 1
          fi
          
          echo "编译后磁盘空间:"
          df -h
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十九步：后处理
      - name: Post-build processing
        if: success()
        run: |
          echo "后处理..."
          mkdir -p ${{ env.WORKSPACE_PATH }}/artifacts
          cd istoreos/openwrt
          
          # 复制固件文件
          find bin/targets -type f \( -name "*.img" -o -name "*.bin" -o -name "*.gz" \) -exec cp {} ${{ env.WORKSPACE_PATH }}/artifacts/ \;
          
          # 复制日志和配置
          cp build.log ${{ env.WORKSPACE_PATH }}/artifacts/build.log 2>/dev/null || true
          cp .config ${{ env.WORKSPACE_PATH }}/artifacts/config 2>/dev/null || true
          
          echo "产物列表:"
          ls -la ${{ env.WORKSPACE_PATH }}/artifacts/
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第二十步：上传产物
      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE }}-${{ env.BUILD_TYPE }}-firmware-${{ github.run_number }}
          path: ${{ env.WORKSPACE_PATH }}/artifacts/*
          retention-days: 14
          if-no-files-found: error

      # 第二十一步：编译失败诊断
      - name: Diagnostics on failure
        if: failure()
        run: |
          echo "=== 编译失败诊断 ==="
          echo "磁盘空间:"
          df -h
          echo "内存使用:"
          free -h
          if [ -f "${{ env.WORKSPACE_PATH }}/istoreos/openwrt/build.log" ]; then
            echo "编译日志最后100行:"
            tail -100 "${{ env.WORKSPACE_PATH }}/istoreos/openwrt/build.log"
          fi
          
          # 显示最大的文件
          echo "最大的10个文件:"
          find "${{ env.WORKSPACE_PATH }}" -type f -size +10M -exec ls -lh {} \; 2>/dev/null | head -10 || true
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第二十二步：清理工作空间
      - name: Cleanup workspace
        if: always()
        run: |
          echo "清理工作空间..."
          if [ -d "${{ env.WORKSPACE_PATH }}" ]; then
            echo "删除工作目录: ${{ env.WORKSPACE_PATH }}"
            rm -rf "${{ env.WORKSPACE_PATH }}"
          fi
          echo "最终磁盘空间状态:"
          df -h