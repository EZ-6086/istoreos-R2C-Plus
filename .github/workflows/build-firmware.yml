name: Build iStoreOS for R2C Plus (Stable)

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本号'
        required: false
        default: '$(date +%Y%m%d)'

env:
  DEVICE: nanopi-r2c-plus
  LAN_IP: 192.168.101.1
  LAN_NETMASK: 255.255.255.0
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: configs/r2cplus.config

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1

    - name: Initial disk space optimization
      run: |
        echo "=== 初始磁盘空间优化 ==="
        df -h
        
        # 清理系统预置的大型开发工具
        sudo rm -rf /usr/local/lib/android || true
        sudo rm -rf /usr/share/dotnet || true
        sudo rm -rf /opt/ghc || true
        sudo rm -rf /usr/local/share/boost || true
        
        # 清理系统缓存
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        
        echo "=== 优化后磁盘空间 ==="
        df -h

    - name: Install essential dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache file g++ gawk gettext git \
          libelf-dev libncurses5-dev libncursesw5-dev libssl-dev \
          python3 python3-pip rsync subversion swig time \
          xsltproc zlib1g-dev binutils bzip2 flex gperf unzip \
          wget curl dos2unix
        
        # 安装Python依赖
        python3 -m pip install --upgrade pip
        pip install pyelftools

    - name: Clone iStoreOS source with retry
      run: |
        # 添加重试机制
        for i in {1..3}; do
          if git clone https://github.com/istoreos/istoreos.git --depth=1 -b main && \
             cd istoreos && \
             git clone https://git.openwrt.org/openwrt/openwrt.git --depth=1 -b openwrt-22.03 openwrt; then
            echo "克隆成功在第 $i 次尝试"
            break
          else
            echo "克隆失败，重试 $i/3..."
            rm -rf istoreos
            sleep 30
          fi
        done

    - name: Configure feeds with stability fixes
      run: |
        cd istoreos/openwrt
        
        # 使用稳定的feed配置
        {
          echo 'src-git friendlywrt https://github.com/friendlyarm/friendlywrt.git^a1b2c3d4e5f67890'
          echo 'src-git istore https://github.com/linkease/istore.git^b2c3d4e5f67890a1'
          echo 'src-git packages https://git.openwrt.org/feed/packages.git^c3d4e5f67890a1b2'
          echo 'src-git luci https://git.openwrt.org/project/luci.git^d4e5f67890a1b2c3'
        } > "$FEEDS_CONF"

    - name: Update feeds with robust error handling
      run: |
        cd istoreos/openwrt
        
        # 分步更新feeds，添加重试机制
        for feed in luci packages routing telephony; do
          for i in {1..3}; do
            if ./scripts/feeds update $feed; then
              echo "成功更新 $feed feed"
              break
            else
              echo "更新 $feed feed 失败 (尝试 $i/3)"
              if [ $i -eq 3 ]; then
                echo "关键feed更新失败，无法继续"
                exit 1
              fi
              sleep 30
            fi
          done
        done
        
        # 安装feeds
        ./scripts/feeds install -a

    - name: Fix common Makefile issues
      run: |
        cd istoreos/openwrt
        
        # 修复常见的Makefile语法错误
        echo "检查并修复Makefile问题..."
        
        # 修复luci-app-cpufreq Makefile
        if [ -f "feeds/friendlywrt/package/friendlyelec/luci-app-cpufreq/Makefile" ]; then
          sed -i 's/PKG_VERSION:=.*/PKG_VERSION:=1.0/' feeds/friendlywrt/package/friendlyelec/luci-app-cpufreq/Makefile
          sed -i 's/PKG_RELEASE:=.*/PKG_RELEASE:=1/' feeds/friendlywrt/package/friendlyelec/luci-app-cpufreq/Makefile
        fi
        
        # 修复luci-app-store Makefile
        if [ -f "feeds/istore/luci/luci-app-store/Makefile" ]; then
          sed -i 's/PKG_VERSION:=.*/PKG_VERSION:=1.0/' feeds/istore/luci/luci-app-store/Makefile
        fi
        
        # 确保所有Makefile有基本的结构
        find feeds -name "Makefile" -exec sed -i '1i\\include $(TOPDIR)/rules.mk' {} \; 2>/dev/null || true

    - name: Apply device configuration
      run: |
        cd istoreos/openwrt
        
        # 复制配置文件
        cp ../../$CONFIG_FILE .config
        
        # 设置网络配置
        sed -i "s/CONFIG_TARGET_IP_ADDR=.*/CONFIG_TARGET_IP_ADDR=\"$LAN_IP\"/" .config
        sed -i "s/CONFIG_TARGET_NETMASK=.*/CONFIG_TARGET_NETMASK=\"$LAN_NETMASK\"/" .config
        
        make defconfig

    - name: Download packages with enhanced retry
      run: |
        cd istoreos/openwrt
        
        # 增强的下载重试机制
        for i in {1..5}; do
          if make download -j8; then
            echo "包下载成功"
            break
          else
            echo "包下载失败，重试 $i/5..."
            sleep 60
          fi
        done

    - name: Build firmware with error recovery
      run: |
        cd istoreos/openwrt
        
        # 尝试编译，失败时提供详细错误信息
        if ! make -j$(nproc) V=s; then
          echo "编译失败，尝试单线程编译..."
          make -j1 V=s || {
            echo "最终编译失败"
            # 收集错误日志
            find . -name "dump.txt" -exec head -100 {} \; 2>/dev/null || true
            exit 1
          }
        fi

    - name: Collect artifacts
      if: success()
      run: |
        cd istoreos/openwrt
        mkdir -p ../../artifacts
        
        # 收集生成的固件
        find bin -name "*.img" -o -name "*.bin" -o -name "*.gz" | head -10 | while read file; do
          cp "$file" ../../artifacts/
        done

    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.DEVICE }}-firmware
        path: artifacts/*
