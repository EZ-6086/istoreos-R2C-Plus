name: Build iStoreOS for R2C Plus (Stable)

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本号'
        required: false
        default: '$(date +%Y%m%d)'

env:
  DEVICE: nanopi-r2c-plus
  LAN_IP: 192.168.101.1
  LAN_NETMASK: 255.255.255.0
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: configs/r2cplus.config

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300 # 延长超时时间

    steps:
      # 第一步：检出代码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      # 第二步：初始磁盘清理（关键步骤）
      - name: Initial disk space cleanup
        run: |
          echo "初始磁盘空间:"
          df -h
          echo "开始清理系统..."
          sudo apt-get clean
          sudo rm -rf /usr/local/lib/android \
                      /usr/share/dotnet \
                      /opt/ghc \
                      /opt/hostedtoolcache/CodeQL \
                      /opt/pipx
          docker system prune -af || true
          echo "清理后磁盘空间:"
          df -h

      # 第三步：安装核心依赖
      - name: Install core dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential ccache file gawk gettext git \
            libncurses5-dev libncursesw5-dev libssl-dev python3 \
            python3-pip subversion unzip wget curl zlib1g-dev \
            rsync time
          pip install pyelftools

      # 第四步：准备源码目录
      - name: Prepare source directory
        run: |
          mkdir -p istoreos
          cd istoreos

      # 第五步：克隆源码（带重试机制）- 修复了问题
      - name: Clone source code with retry
        run: |
          for i in {1..3}; do
            if git clone --depth=1 -b main https://github.com/istoreos/istoreos.git . && \
               git clone --depth=1 -b openwrt-24.10 https://git.openwrt.org/openwrt/openwrt.git openwrt; then
              echo "源码克隆成功 (尝试 $i)"
              break
            else
              echo "克隆失败，重试 $i/3..."
              rm -rf ./*
              sleep 30
            fi
          done
        working-directory: ./istoreos

      # 第六步：配置Feeds（修复网络问题）
      - name: Configure feeds with stability
        run: |
          # 使用稳定的feed配置
          cat > "$FEEDS_CONF" << 'EOF'
          src-git friendlywrt https://github.com/friendlyarm/friendlywrt.git;master-v24.10
          src-git istore https://github.com/linkease/istore.git;main
          src-git packages https://git.openwrt.org/feed/packages.git;openwrt-24.10
          src-git luci https://git.openwrt.org/project/luci.git;openwrt-24.10
          src-git routing https://git.openwrt.org/feed/routing.git;openwrt-24.10
          src-git telephony https://git.openwrt.org/feed/telephony.git;openwrt-24.10
          EOF
        working-directory: ./istoreos/openwrt

      # 第七步：更新Feeds（分步进行，增强稳定性）- 修复了问题
      - name: Update feeds step by step
        run: |
          # 分步更新，避免单点失败影响全部
          for feed in luci packages routing telephony friendlywrt istore; do
            for i in {1..3}; do
              echo "更新 $feed feed (尝试 $i/3)"
              if ./scripts/feeds update $feed; then
                echo "$feed 更新成功"
                break
              elif [ $i -eq 3 ]; then
                echo "警告: $feed 更新失败，继续执行..."
                # 不退出，继续其他feed的更新
              else
                sleep 30
              fi
            done
          done
        working-directory: ./istoreos/openwrt

      # 第八步：安装Feeds
      - name: Install all feeds
        run: |
          ./scripts/feeds install -a
        working-directory: ./istoreos/openwrt

      # 第九步：应用基础补丁 - 修复了语法错误
      - name: Apply basic device patches
        run: |
          # 确保设备定义存在
          if ! grep -q "friendlyarm_nanopi-r2c-plus" target/linux/rockchip/image/armv8.mk; then
            cat >> target/linux/rockchip/image/armv8.mk << 'EOF'
          
          define Device/friendlyarm_nanopi-r2c-plus
            DEVICE_VENDOR := FriendlyARM
            DEVICE_MODEL := NanoPi R2C Plus
            SOC := rk3328
            IMAGE/sysupgrade.img.gz := boot-combined | boot-script nanopi-r2c-plus | sdcard-img | gzip | append-metadata
            DEVICE_PACKAGES := kmod-usb-net-rtl8152 kmod-r8169
          endef
          TARGET_DEVICES += friendlyarm_nanopi-r2c-plus
          EOF
          fi
        working-directory: ./istoreos/openwrt

      # 第十步：复制配置文件 - 修复了路径问题
      - name: Copy configuration file
        run: |
          # 检查配置文件是否存在
          if [ -f "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
            echo "使用自定义配置文件: $CONFIG_FILE"
            cp "$GITHUB_WORKSPACE/$CONFIG_FILE" .config
          else
            echo "使用默认配置"
            # 创建基础配置
            make defconfig
          fi
          
          # 设置默认IP
          sed -i "s/CONFIG_TARGET_IP_ADDR=.*/CONFIG_TARGET_IP_ADDR=\"$LAN_IP\"/" .config 2>/dev/null || true
          sed -i "s/CONFIG_TARGET_NETMASK=.*/CONFIG_TARGET_NETMASK=\"$LAN_NETMASK\"/" .config 2>/dev/null || true
          
          # 确认配置
          make defconfig
        working-directory: ./istoreos/openwrt

      # 第十一步：下载软件包（带重试）
      - name: Download packages with retry
        run: |
          for i in {1..3}; do
            if make -j$(nproc) download; then
              echo "包下载成功"
              break
            elif [ $i -eq 3 ]; then
              echo "错误: 包下载失败"
              exit 1
            else
              echo "包下载失败，重试 $i/3..."
              sleep 60
            fi
          done
        working-directory: ./istoreos/openwrt

      # 第十二步：最终磁盘清理
      - name: Final disk cleanup before build
        run: |
          echo "编译前最终磁盘空间:"
          df -h
          sudo apt-get autoremove -y
          sudo apt-get clean

      # 第十三步：编译固件（优化线程数）
      - name: Build firmware (optimized thread count)
        run: |
          cd ./istoreos/openwrt
          # 根据可用CPU核心数调整线程数，但限制最大为2以避免内存不足
          CPU_CORES=$(nproc)
          BUILD_JOBS=$((CPU_CORES > 2 ? 2 : CPU_CORES))
          echo "使用 $BUILD_JOBS 个线程编译"
          
          # 开始编译
          make -j$BUILD_JOBS V=s 2>&1 | tee build.log
          
          # 检查编译结果
          if [ $? -eq 0 ]; then
            echo "编译成功完成!"
          else
            echo "编译失败!"
            exit 1
          fi

      # 第十四步：收集构建产物
      - name: Collect build artifacts
        if: success()
        run: |
          cd ./istoreos/openwrt
          mkdir -p $GITHUB_WORKSPACE/artifacts
          
          # 查找固件文件
          FIRMWARE_FILES=$(find bin/targets -type f \( -name "*.img" -o -name "*.bin" -o -name "*.gz" -o -name "*.zip" \) 2>/dev/null || true)
          
          if [ -n "$FIRMWARE_FILES" ]; then
            echo "找到固件文件:"
            echo "$FIRMWARE_FILES"
            echo "$FIRMWARE_FILES" | xargs -I {} cp {} $GITHUB_WORKSPACE/artifacts/
          else
            echo "警告: 未找到固件文件"
            # 尝试查找其他构建输出
            find bin/targets -type f | head -20
          fi
          
          # 保存构建日志
          [ -f build.log ] && cp build.log $GITHUB_WORKSPACE/artifacts/ || true
          
          # 保存配置文件
          [ -f .config ] && cp .config $GITHUB_WORKSPACE/artifacts/ || true
          
          echo "构建产物列表:"
          ls -la $GITHUB_WORKSPACE/artifacts/

      # 第十五步：上传产物
      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE }}-firmware-${{ github.run_id }}
          path: artifacts/*
          retention-days: 7

      # 第十六步：失败时收集诊断信息
      - name: Collect diagnostics on failure
        if: failure()
        run: |
          echo "=== 编译失败诊断 ==="
          
          # 检查磁盘空间
          echo "磁盘空间使用情况:"
          df -h
          
          echo "内存使用情况:"
          free -h
          
          # 检查关键错误
          if [ -f ./istoreos/openwrt/build.log ]; then
            echo "=== 构建日志最后200行 ==="
            tail -200 ./istoreos/openwrt/build.log
          else
            echo "无构建日志"
          fi
          
          # 查找Makefile错误
          if [ -d ./istoreos/openwrt/logs ]; then
            echo "=== 错误日志摘要 ==="
            find ./istoreos/openwrt/logs -name "*.log" -exec echo "=== {} ===" \; -exec tail -50 {} \; 2>/dev/null || true
          fi
