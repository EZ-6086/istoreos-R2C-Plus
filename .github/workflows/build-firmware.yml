name: Build iStoreOS for R2C Plus

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本号'
        required: false
        default: '$(date +%Y%m%d)'

env:
  DEVICE: nanopi-r2c-plus
  LAN_IP: 192.168.101.1
  LAN_NETMASK: 255.255.255.0
  LAN_DHCP_START: 100
  LAN_DHCP_END: 250
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: configs/r2cplus.config

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    strategy:
      matrix:
        include:
          - target: rockchip/armv8
            profile: friendlyarm_nanopi-r2c-plus
            subtarget: rockchip_armv8

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1

    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk gettext git java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev libssl-dev python3 python3-distutils python3-setuptools python3-dev python3-pip rsync subversion swig time xsltproc zlib1g-dev binutils bzip2 flex gcc-multilib g++-multilib gperf unzip libxml-parser-perl mercurial wget curl mc tree dos2unix
        echo "CCACHE_DIR=$GITHUB_WORKSPACE/ccache" >> $GITHUB_ENV
        ccache -o max_size=5G

    - name: Prepare toolchain
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Clone iStoreOS source
      run: |
        git clone https://github.com/istoreos/istoreos.git --depth=1 -b main
        cd istoreos
        git clone https://git.openwrt.org/openwrt/openwrt.git --depth=1 -b openwrt-24.10 openwrt
        cd openwrt

    - name: Configure feeds
      run: |
        cd istoreos/openwrt
        {
          echo 'src-git friendlywrt https://github.com/friendlyarm/friendlywrt.git;master-v24.10'
          echo 'src-git istore https://github.com/linkease/istore.git;main'
          echo 'src-git packages https://git.openwrt.org/feed/packages.git;openwrt-24.10'
          echo 'src-git luci https://git.openwrt.org/project/luci.git;openwrt-24.10'
          echo 'src-git routing https://git.openwrt.org/feed/routing.git;openwrt-24.10'
          echo 'src-git telephony https://git.openwrt.org/feed/telephony.git;openwrt-24.10'
        } > "$FEEDS_CONF"
        
        # 显示feeds配置
        echo "=== 当前feeds配置 ==="
        cat "$FEEDS_CONF"

    - name: Update and install feeds
      run: |
        cd istoreos/openwrt
        echo "=== 开始更新feeds ==="
        ./scripts/feeds update -a
        
        echo "=== 开始安装feeds ==="
        ./scripts/feeds install -a
        
        echo "=== 安装iStore feed ==="
        ./scripts/feeds install istore
        
        echo "=== Feeds 状态 (前20个) ==="
        ./scripts/feeds list | head -20

    - name: Apply R2C Plus patches
      run: |
        cd istoreos/openwrt
        chmod +x ../../scripts/apply_patches.sh
        ../../scripts/apply_patches.sh

    - name: Run custom scripts
      run: |
        cd istoreos/openwrt
        chmod +x ../../scripts/custom_scripts.sh
        ../../scripts/custom_scripts.sh

    - name: Copy configuration
      run: |
        cd istoreos/openwrt
        cp ../../$CONFIG_FILE .config
        sed -i "s/CONFIG_TARGET_IP_ADDR=.*/CONFIG_TARGET_IP_ADDR=\"$LAN_IP\"/" .config
        sed -i "s/CONFIG_TARGET_NETMASK=.*/CONFIG_TARGET_NETMASK=\"$LAN_NETMASK\"/" .config
        make defconfig
        ./scripts/diffconfig.sh > diffconfig.log
        cat diffconfig.log

    - name: Download packages
      run: |
        cd istoreos/openwrt
        echo "=== 开始下载包 ==="
        make -j$(nproc) download || make -j1 V=s download
        echo "=== 验证下载完整性 ==="
        make -j1 V=s download

    - name: Build firmware
      run: |
        cd istoreos/openwrt
        echo "=== 开始编译固件 ==="
        make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log || {
          echo "多线程编译失败，尝试单线程编译..."
          make -j1 V=s 2>&1 | tee build-single.log
        }

    - name: Print feed dump logs
      if: failure()
      run: |
        cd istoreos/openwrt
        set -euo pipefail
        shopt -s globstar nullglob || true
        echo "=== 开始收集feed错误日志 ==="
        for f in logs/feeds/**/dump.txt; do
          echo "========== $f =========="
          if [ -f "$f" ]; then
            head -200 "$f" || cat "$f"
          else
            echo "文件不存在: $f"
          fi
          echo ""
        done
        echo "=== feed错误日志收集完成 ==="

    - name: Upload feed dump logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: feed-dump-logs-${{ github.run_id }}
        path: istoreos/openwrt/logs/feeds/**/dump.txt
        retention-days: 7

    - name: Collect artifacts
      if: success()
      run: |
        cd istoreos/openwrt
        mkdir -p ../../artifacts
        find bin/targets -name "*.img*" -o -name "*.bin*" -o -name "*.gz*" | xargs -I {} cp {} ../../artifacts/
        cp .config ../../artifacts/
        cp build.log ../../artifacts/ 2>/dev/null || true
        cp build-single.log ../../artifacts/ 2>/dev/null || true
        cp diffconfig.log ../../artifacts/ 2>/dev/null || true
        echo "Build date: $(date)" > ../../artifacts/build-info.txt
        echo "Git commit: $GITHUB_SHA" >> ../../artifacts/build-info.txt
        echo "Device: $DEVICE" >> ../../artifacts/build-info.txt
        echo "LAN IP: $LAN_IP" >> ../../artifacts/build-info.txt
        echo "OpenWrt version: 24.10" >> ../../artifacts/build-info.txt
        echo "iStoreOS branch: main" >> ../../artifacts/build-info.txt
        echo "FriendlyWrt branch: master-v24.10" >> ../../artifacts/build-info.txt
        echo "iStore feed: linkease/istore" >> ../../artifacts/build-info.txt

    - name: Upload firmware artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.DEVICE }}-firmware-${{ github.run_id }}
        path: artifacts/*
        retention-days: 30
        if-no-files-found: error
