name: Build iStoreOS for R2C Plus (Optimized)

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本号'
        required: false
        default: '$(date +%Y%m%d)'

env:
  DEVICE: nanopi-r2c-plus
  LAN_IP: 192.168.101.1
  LAN_NETMASK: 255.255.255.0
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: configs/r2cplus.config

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    
    steps:
    - name: Checkout repository with minimal depth
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1

    - name: Initial disk space optimization
      run: |
        echo "=== 初始磁盘空间优化 ==="
        df -h
        
        # 清理系统预置的大型开发工具
        sudo rm -rf /usr/local/lib/android || true
        sudo rm -rf /usr/share/dotnet || true
        sudo rm -rf /opt/ghc || true
        sudo rm -rf /usr/local/share/boost || true
        sudo rm -rf /opt/az || true
        sudo rm -rf /usr/local/lib32 || true
        
        # 清理系统缓存
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        
        # 清理Docker缓存
        docker system prune -af || true
        docker builder prune -af || true
        
        echo "=== 优化后磁盘空间 ==="
        df -h

    - name: Install essential dependencies only
      run: |
        sudo apt-get update
        # 仅安装核心编译依赖，避免不必要的包
        sudo apt-get install -y \
          build-essential ccache file g++ gawk gettext git \
          libelf-dev libncurses5-dev libncursesw5-dev libssl-dev \
          python3 python3-pip rsync subversion swig time \
          xsltproc zlib1g-dev binutils bzip2 flex gperf unzip \
          wget curl dos2unix
        
        # 安装Python依赖
        python3 -m pip install --upgrade pip
        pip install pyelftools
        
        # 优化ccache配置
        echo "CCACHE_DIR=$GITHUB_WORKSPACE/ccache" >> $GITHUB_ENV
        ccache -o max_size=1G

    - name: Clone iStoreOS source with space optimization
      run: |
        # 使用浅克隆减少存储占用
        git clone https://github.com/istoreos/istoreos.git --depth=1 -b main --single-branch
        cd istoreos
        git clone https://git.openwrt.org/openwrt/openwrt.git --depth=1 -b openwrt-24.10 openwrt --single-branch
        cd openwrt

    - name: Configure feeds for OpenWrt 24.10
      run: |
        cd istoreos/openwrt
        {
          echo 'src-git friendlywrt https://github.com/friendlyarm/friendlywrt.git;master-v24.10'
          echo 'src-git istore https://github.com/linkease/istore.git;main'
          echo 'src-git packages https://git.openwrt.org/feed/packages.git;openwrt-24.10'
          echo 'src-git luci https://git.openwrt.org/project/luci.git;openwrt-24.10'
        } > "$FEEDS_CONF"
        
        # 修复行尾格式
        find . -name "*.sh" -type f -exec dos2unix {} \; 2>/dev/null || true

    - name: Update and install feeds with retry
      run: |
        cd istoreos/openwrt
        # 分步更新feeds，减少内存压力
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        ./scripts/feeds install istore

    - name: Intermediate disk cleanup
      run: |
        echo "=== feeds安装后中间清理 ==="
        # 再次清理系统空间
        sudo apt-get autoremove -y
        sudo apt-get clean
        sudo rm -rf /tmp/*
        
        cd istoreos/openwrt
        # 清理可能的临时文件
        rm -rf tmp/* 2>/dev/null || true
        
        echo "=== 当前磁盘空间 ==="
        df -h

    - name: Intermediate disk cleanup
      run: |
        echo "=== feeds安装后中间清理 ==="
        # 再次清理系统空间
        sudo apt-get autoremove -y
        sudo apt-get clean
        sudo rm -rf /tmp/*
        
        cd istoreos/openwrt
        # 清理可能的临时文件
        rm -rf tmp/* 2>/dev/null || true
        
        echo "=== 当前磁盘空间 ==="
        df -h

    # 修复点1：确保此步骤与前后步骤的缩进对齐，且独立成一项
    - name: Apply essential patches only
      run: |
        cd istoreos/openwrt
        if ! grep -q "nanopi-r2c-plus" target/linux/rockchip/image/armv8.mk 2>/dev/null; then
          echo "添加R2C Plus设备支持..."
          echo "" >> target/linux/rockchip/image/armv8.mk
          echo "define Device/friendlyarm_nanopi-r2c-plus" >> target/linux/rockchip/image/armv8.mk
          echo "  DEVICE_VENDOR := FriendlyARM" >> target/linux/rockchip/image/armv8.mk
          echo "  DEVICE_MODEL := NanoPi R2C Plus" >> target/linux/rockchip/image/armv8.mk
          # ... 请确保这里完整填写所有echo命令 ...
          echo "endef" >> target/linux/rockchip/image/armv8.mk
          echo "TARGET_DEVICES += friendlyarm_nanopi-r2c-plus" >> target/linux/rockchip/image/armv8.mk
        fi

    # 修复点2：此步骤必须是与前一步骤平级的独立项，而非嵌套在内
    - name: Copy configuration with IP settings
      run: |
        cd istoreos/openwrt
        cp ../../$CONFIG_FILE .config
        
        # 设置默认IP
        sed -i "s/CONFIG_TARGET_IP_ADDR=.*/CONFIG_TARGET_IP_ADDR=\"$LAN_IP\"/" .config
        sed -i "s/CONFIG_TARGET_NETMASK=.*/CONFIG_TARGET_NETMASK=\"$LAN_NETMASK\"/" .config
        
        make defconfig
        ./scripts/diffconfig.sh > diffconfig.log

    - name: Download packages with space management
      run: |
        cd istoreos/openwrt
        echo "=== 开始下载包（空间优化） ==="
        
        # 使用单线程下载，减少内存压力
        make -j1 download V=s || {
          echo "下载失败，重试..."
          make -j1 download V=s
        }
        
        echo "=== 下载后磁盘空间 ==="
        df -h

    # 修复点3：此步骤不完整，请补充完整的run命令
    - name: Pre-compilation cleanup
      run: |
        echo "=== 编译前最终清理 ==="
        # 最后一次空间清理
        sudo apt-get clean
        sudo rm -rf /var/cache/apt/archives/*
        docker system prune -af || true
        
        cd istoreos/openwrt
        # 清理不必要的开发文件
        find . -name "*.o" -delete 2>/dev/null || true
        
        echo "=== 最终可用空间 ==="
        df -h

    - name: Pre-compilation cleanup
      run: |
        echo "=== 编译前最终清理 ==="
        # 最后一次空间清理
        sudo apt-get clean
        sudo rm -rf /var/cache/apt


