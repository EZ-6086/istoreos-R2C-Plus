name: Build iStoreOS for R2C Plus

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本号'
        required: false
        default: '$(date +%Y%m%d)'

env:
  DEVICE: nanopi-r2c-plus
  LAN_IP: 192.168.101.1
  LAN_NETMASK: 255.255.255.0
  LAN_DHCP_START: 100
  LAN_DHCP_END: 250
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: configs/r2cplus.config

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    strategy:
      matrix:
        include:
          - target: rockchip/armv8
            profile: friendlyarm_nanopi-r2c-plus
            subtarget: rockchip_armv8

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1

    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk gettext git java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev libssl-dev python3 python3-distutils python3-setuptools python3-dev python3-pip rsync subversion swig time xsltproc zlib1g-dev binutils bzip2 flex gcc-multilib g++-multilib gperf unzip libxml-parser-perl mercurial wget curl mc tree
        echo "CCACHE_DIR=$GITHUB_WORKSPACE/ccache" >> $GITHUB_ENV
        ccache -o max_size=5G

    - name: Prepare toolchain
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Clone iStoreOS source
      run: |
        git clone https://github.com/istoreos/istoreos.git --depth=1 -b main
        cd istoreos
        git clone https://git.openwrt.org/openwrt/openwrt.git --depth=1 -b openwrt-22.03 openwrt
        cd openwrt

    - name: Configure feeds
      run: |
        cd istoreos/openwrt
        {
          echo 'src-git friendlywrt https://github.com/friendlyarm/friendlywrt.git;master-v24.10'
          echo 'src-git istore https://github.com/linkease/istore.git;main'
          echo 'src-git packages https://git.openwrt.org/feed/packages.git^e0e38e7f3a8b6b7d1a34d0c6b4e5e6f7a8b9c0d1'
          echo 'src-git luci https://git.openwrt.org/project/luci.git^a1b2c3d4e5f67890'
          echo 'src-git routing https://git.openwrt.org/feed/routing.git'
          echo 'src-git telephony https://git.openwrt.org/feed/telephony.git'
        } > "$FEEDS_CONF"
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        ./scripts/feeds install istore

    - name: Apply R2C Plus patches
      run: |
        cd istoreos/openwrt
        chmod +x ../../scripts/apply_patches.sh
        ../../scripts/apply_patches.sh

    - name: Run custom scripts
      run: |
        cd istoreos/openwrt
        chmod +x ../../scripts/custom_scripts.sh
        ../../scripts/custom_scripts.sh

    - name: Copy configuration
      run: |
        cd istoreos/openwrt
        cp ../../$CONFIG_FILE .config
        sed -i "s/CONFIG_TARGET_IP_ADDR=.*/CONFIG_TARGET_IP_ADDR=\"$LAN_IP\"/" .config
        sed -i "s/CONFIG_TARGET_NETMASK=.*/CONFIG_TARGET_NETMASK=\"$LAN_NETMASK\"/" .config
        make defconfig
        ./scripts/diffconfig.sh > diffconfig.log
        cat diffconfig.log

    - name: Download packages
      run: |
        cd istoreos/openwrt
        make -j$(nproc) download || make -j1 V=s download
        make -j1 V=s download

    - name: Build firmware
      run: |
        cd istoreos/openwrt
        make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log || {
          echo "Build failed, trying single thread..."
          make -j1 V=s 2>&1 | tee build-single.log
        }

    - name: Collect artifacts
      run: |
        cd istoreos/openwrt
        mkdir -p ../../artifacts
        find bin/targets -name "*.img*" -o -name "*.bin*" -o -name "*.gz*" | xargs -I {} cp {} ../../artifacts/
        cp .config ../../artifacts/
        cp build.log ../../artifacts/ 2>/dev/null || true
        cp build-single.log ../../artifacts/ 2>/dev/null || true
        echo "Build date: $(date)" > ../../artifacts/build-info.txt
        echo "Git commit: $GITHUB_SHA" >> ../../artifacts/build-info.txt
        echo "Device: $DEVICE" >> ../../artifacts/build-info.txt
        echo "LAN IP: $LAN_IP" >> ../../artifacts/build-info.txt

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.DEVICE }}-firmware-${{ github.run_id }}
        path: artifacts/*
        retention-days: 30
        if-no-files-found: error


