# ====================================================
# iStoreOS for NanoPi R2C Plus GitHub Actions 配置
# 版本: 3.0
# 更新日期: $(date +%Y-%m-%d)
# 描述: 优化版 GitHub Actions 工作流，利用 /home/runner 上的空间（用户有权限）
# ====================================================

name: Build iStoreOS for R2C Plus (Optimized - Disk Space)

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - '**/README.md'
      - '.gitignore'
      - '.gitattributes'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: '固件版本号'
        required: false
        default: '$(date +%Y%m%d)'
      build_type:
        description: '构建类型'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - minimal
          - docker
      clean_build:
        description: '是否清理缓存重新构建'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  DEVICE: nanopi-r2c-plus
  LAN_IP: 192.168.101.1
  LAN_NETMASK: 255.255.255.0
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: configs/r2cplus.config
  WORKSPACE_PATH: /home/runner/istoreos-build
  CACHE_PATH: /home/runner/openwrt-cache

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    strategy:
      matrix:
        type: ['full']
    
    steps:
      # 第一步：初始磁盘空间检查并创建工作目录
      - name: Initial disk space check and prepare workspace
        run: |
          echo "=== 初始磁盘空间状态 ==="
          df -h
          echo "内存状态:"
          free -h
          echo "========================="
          
          # 创建主工作目录在 /home/runner（充足空间）
          echo "创建工作目录: ${{ env.WORKSPACE_PATH }}"
          mkdir -p ${{ env.WORKSPACE_PATH }}
          mkdir -p ${{ env.CACHE_PATH }}
          
          # 设置权限（确保后续步骤可写）
          sudo chmod -R 777 ${{ env.WORKSPACE_PATH }} || true
          sudo chown -R runner:runner ${{ env.WORKSPACE_PATH }} || true
          
          echo "工作目录创建完成"
          ls -ld ${{ env.WORKSPACE_PATH }}
          ls -ld ${{ env.CACHE_PATH }}

      # 第二步：检出代码到默认位置
      - name: Checkout repository (to default location)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1
          lfs: false

      # 第三步：将源码复制到自定义工作空间
      - name: Copy source to custom workspace
        run: |
          echo "复制源码到自定义工作空间: ${{ env.WORKSPACE_PATH }}"
          cp -r ${{ github.workspace }}/. ${{ env.WORKSPACE_PATH }}/
          echo "复制完成。自定义工作空间内容："
          ls -la ${{ env.WORKSPACE_PATH }}/

      # 第四步：设置构建缓存（只缓存dl目录）
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.CACHE_PATH }}/dl  # 只缓存下载的包
          key: ${{ runner.os }}-openwrt-dl-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-openwrt-dl-

      # 第五步：修复脚本权限和格式
      - name: Fix script permissions and format
        run: |
          echo "修复脚本文件..."
          # 注意：这里所有路径都基于 ${{ env.WORKSPACE_PATH }}
          if [ -d "${{ env.WORKSPACE_PATH }}/scripts" ]; then
            echo "修复脚本换行符..."
            find "${{ env.WORKSPACE_PATH }}/scripts" -name "*.sh" -type f -exec sed -i 's/\r$//' {} \;
            echo "设置脚本执行权限..."
            find "${{ env.WORKSPACE_PATH }}/scripts" -name "*.sh" -type f -exec chmod +x {} \;
          else
            echo "警告: scripts 目录不存在，创建..."
            mkdir -p "${{ env.WORKSPACE_PATH }}/scripts"
          fi
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第六步：系统清理和依赖安装
      - name: System cleanup and dependencies
        run: |
          echo "=== 系统清理和依赖安装 ==="
          sudo apt-get clean
          sudo apt-get autoremove -y
          sudo rm -rf /tmp/* /var/tmp/*
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential ecj fastjar file g++ gawk \
            gettext git java-propose-classpath libelf-dev libncurses5-dev \
            libncursesw5-dev libssl-dev python3 python3-pip python3-setuptools \
            python3-dev python3-venv rsync subversion swig time unzip wget \
            xsltproc zlib1g-dev cpio curl gcc-multilib gperf libxml-parser-perl \
            ocaml-nox sharutils texinfo yui-compressor upx-ucl cmake pkg-config \
            automake autoconf libtool flex bison gcc g++ make patch perl \
            libjson-perl libxml-simple-perl libfile-slurp-perl dos2unix
          pip install pyelftools
          echo "清理后磁盘空间:"
          df -h

      # 第七步：准备源码目录结构
      - name: Prepare source directory structure
        run: |
          echo "准备源码目录结构..."
          mkdir -p istoreos
          cd istoreos
          echo "当前目录: $(pwd)"
          ls -la
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第八步：克隆 iStoreOS 源码
      - name: Clone iStoreOS source
        run: |
          echo "克隆 iStoreOS 源码..."
          cd istoreos
          for i in {1..3}; do
            echo "尝试 $i/3..."
            if git clone --depth=1 -b main https://github.com/istoreos/istoreos.git .; then
              echo "iStoreOS 克隆成功"
              break
            elif [ $i -eq 3 ]; then
              echo "错误: iStoreOS 克隆失败"
              exit 1
            else
              sleep 30
            fi
          done
          echo "克隆完成，目录内容:"
          ls -la
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第九步：克隆 OpenWrt 源码
      - name: Clone OpenWrt source
        run: |
          echo "克隆 OpenWrt 源码..."
          cd istoreos
          for i in {1..3}; do
            echo "尝试 $i/3..."
            if git clone --depth=1 -b openwrt-24.10 https://github.com/openwrt/openwrt.git openwrt; then
              echo "OpenWrt 克隆成功"
              break
            elif [ $i -eq 3 ]; then
              echo "错误: OpenWrt 克隆失败，尝试官方源..."
              if ! git clone --depth=1 -b openwrt-24.10 https://git.openwrt.org/openwrt/openwrt.git openwrt; then
                exit 1
              fi
            else
              sleep 30
            fi
          done
          echo "验证 OpenWrt 目录:"
          ls -la openwrt/
          echo "当前磁盘空间:"
          df -h
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十步：链接缓存目录（只链接dl目录）
      - name: Link cache directories
        run: |
          echo "链接缓存目录..."
          cd istoreos/openwrt
          
          # 只链接dl目录，不链接build_dir和staging_dir以节省空间
          mkdir -p ${{ env.CACHE_PATH }}/dl
          rm -rf dl 2>/dev/null || true
          ln -sf ${{ env.CACHE_PATH }}/dl dl
          
          echo "缓存目录链接完成"
          ls -la | grep -E "^l.*dl"
          du -sh ${{ env.CACHE_PATH }}/dl 2>/dev/null || true
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十一步：配置 Feeds
      - name: Configure feeds
        run: |
          echo "配置 feeds..."
          cd istoreos/openwrt
          cat > "feeds.conf" << 'EOF'
          src-git friendlywrt https://github.com/friendlyarm/friendlywrt.git;master-v24.10
          src-git istore https://github.com/linkease/istore.git;main
          src-git packages https://git.openwrt.org/feed/packages.git;openwrt-24.10
          src-git luci https://git.openwrt.org/project/luci.git;openwrt-24.10
          src-git routing https://git.openwrt.org/feed/routing.git;openwrt-24.10
          src-git telephony https://git.openwrt.org/feed/telephony.git;openwrt-24.10
          EOF
          cat feeds.conf
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十二步：更新和安装 Feeds
      - name: Update and install feeds
        run: |
          echo "更新和安装 feeds..."
          cd istoreos/openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "feeds 安装完成"
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十三步：应用补丁
      - name: Apply patches
        run: |
          echo "应用补丁..."
          cd istoreos/openwrt
          if [ -f "../../scripts/apply_patches.sh" ]; then
            chmod +x "../../scripts/apply_patches.sh"
            "../../scripts/apply_patches.sh"
          else
            echo "没有找到补丁脚本，跳过"
          fi
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十四步：应用自定义脚本
      - name: Apply custom scripts
        run: |
          echo "应用自定义脚本..."
          cd istoreos/openwrt
          if [ -f "../../scripts/custom_scripts.sh" ]; then
            chmod +x "../../scripts/custom_scripts.sh"
            "../../scripts/custom_scripts.sh"
          else
            echo "没有找到自定义脚本，跳过"
          fi
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十五步：复制和配置配置文件
      - name: Copy and configure config file
        run: |
          echo "复制和配置配置文件..."
          cd istoreos/openwrt
          if [ -f "../../${{ env.CONFIG_FILE }}" ]; then
            echo "使用自定义配置文件: ${{ env.CONFIG_FILE }}"
            cp "../../${{ env.CONFIG_FILE }}" .config
          else
            echo "错误: 配置文件不存在"
            exit 1
          fi
          sed -i "s|CONFIG_TARGET_IP_ADDR=.*|CONFIG_TARGET_IP_ADDR=\"$LAN_IP\"|" .config 2>/dev/null || true
          sed -i "s|CONFIG_TARGET_NETMASK=.*|CONFIG_TARGET_NETMASK=\"$LAN_NETMASK\"|" .config 2>/dev/null || true
          make defconfig
          grep -E "CONFIG_TARGET|CONFIG_ARCH|CONFIG_LUCI" .config | head -20
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十六步：下载软件包
      - name: Download packages
        run: |
          echo "下载软件包..."
          cd istoreos/openwrt
          echo "下载前磁盘空间:"
          df -h
          for i in {1..3}; do
            echo "下载尝试 $i/3..."
            if make download -j$(nproc); then
              echo "包下载成功"
              break
            elif [ $i -eq 3 ]; then
              echo "警告: 包下载失败，尝试继续构建..."
            else
              sleep 60
            fi
          done
          echo "下载后磁盘空间:"
          df -h
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十七步：构建前清理
      - name: Cleanup before build
        run: |
          echo "构建前清理..."
          cd istoreos/openwrt
          
          # 清理不必要的文件释放空间
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          
          # 删除旧的编译日志
          rm -rf logs/* 2>/dev/null || true
          
          # 清理一些中间文件
          find . -name "*.o" -type f -delete 2>/dev/null || true
          find . -name "*.tmp" -type f -delete 2>/dev/null || true
          
          echo "当前磁盘空间:"
          df -h
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十八步：编译固件（优化版）
      - name: Build firmware
        run: |
          echo "=== 编译固件开始（优化版） ==="
          cd istoreos/openwrt
          
          # 禁用ccache以节省空间
          unset CCACHE_DIR
          unset CCACHE_MAXSIZE
          
          # 使用更保守的编译线程数
          CPU_CORES=$(nproc)
          BUILD_JOBS=$((CPU_CORES - 1))
          [ $BUILD_JOBS -lt 2 ] && BUILD_JOBS=2
          
          echo "使用编译线程数: $BUILD_JOBS"
          echo "编译前磁盘空间:"
          df -h
          
          # 分步编译，减少内存压力
          echo "阶段1: 编译工具链..."
          time make -j$BUILD_JOBS tools/compile
          
          echo "阶段2: 编译工具..."
          time make -j$BUILD_JOBS toolchain/compile
          
          # 清理中间文件释放空间
          echo "清理中间文件..."
          rm -rf build_dir/*/autoconf-* 2>/dev/null || true
          rm -rf build_dir/*/automake-* 2>/dev/null || true
          
          echo "阶段3: 编译内核..."
          time make -j$BUILD_JOBS target/linux/compile
          
          echo "阶段4: 编译包..."
          # 分批次编译包，减少内存占用
          for i in 1 2 3; do
            echo "第$i轮包编译..."
            time make -j$BUILD_JOBS package/compile || {
              echo "第$i轮编译失败，重试..."
              sleep 5
              time make -j$((BUILD_JOBS/2)) package/compile
            }
            
            # 每轮编译后清理一些中间文件
            if [ $i -lt 3 ]; then
              echo "清理中间文件..."
              find build_dir -name "*.o" -type f -delete 2>/dev/null || true
              find build_dir -name "*.a" -type f -delete 2>/dev/null || true
            fi
          done
          
          echo "最终编译..."
          time make -j$BUILD_JOBS V=s 2>&1 | tee build.log | grep -E "(error|Error|installing|Compiling|Linking)" | tail -200
          
          # 清理编译后的中间文件
          echo "清理编译中间文件..."
          find build_dir -name "*.o" -type f -delete 2>/dev/null || true
          find build_dir -name "*.a" -type f -delete 2>/dev/null || true
          find staging_dir -name "*.a" -type f -delete 2>/dev/null || true
          
          COMPILE_RESULT=$?
          if [ $COMPILE_RESULT -eq 0 ]; then
            echo "编译成功!"
            find bin/targets -name "*.img" -o -name "*.bin" -o -name "*.gz" 2>/dev/null | xargs ls -lh
          else
            echo "编译失败!"
            tail -100 build.log | grep -i error
            exit 1
          fi
          echo "编译后磁盘空间:"
          df -h
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第十九步：后处理
      - name: Post-build processing
        if: success()
        run: |
          echo "后处理..."
          mkdir -p ${{ env.WORKSPACE_PATH }}/artifacts
          cd istoreos/openwrt
          if [ -f "../../scripts/post_build.sh" ]; then
            chmod +x "../../scripts/post_build.sh"
            "../../scripts/post_build.sh" \
              "$(pwd)" \
              "${{ env.WORKSPACE_PATH }}/artifacts"
          else
            find bin/targets -type f \( -name "*.img" -o -name "*.bin" -o -name "*.gz" \) -exec cp {} ${{ env.WORKSPACE_PATH }}/artifacts/ \;
            cp build.log ${{ env.WORKSPACE_PATH }}/artifacts/ 2>/dev/null || true
            cp .config ${{ env.WORKSPACE_PATH }}/artifacts/ 2>/dev/null || true
          fi
          echo "产物列表:"
          ls -la ${{ env.WORKSPACE_PATH }}/artifacts/
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第二十步：上传产物
      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEVICE }}-firmware-${{ github.run_number }}
          path: ${{ env.WORKSPACE_PATH }}/artifacts/*
          retention-days: 30
          if-no-files-found: error

      # 第二十一步：编译失败诊断
      - name: Diagnostics on failure
        if: failure()
        run: |
          echo "=== 编译失败诊断 ==="
          echo "磁盘空间:"
          df -h
          echo "内存使用:"
          free -h
          if [ -f "${{ env.WORKSPACE_PATH }}/istoreos/openwrt/build.log" ]; then
            echo "编译日志最后200行:"
            tail -200 "${{ env.WORKSPACE_PATH }}/istoreos/openwrt/build.log"
          fi
        working-directory: ${{ env.WORKSPACE_PATH }}

      # 第二十二步：清理工作空间
      - name: Cleanup workspace
        if: always()
        run: |
          echo "清理工作空间..."
          if [ -d "${{ env.WORKSPACE_PATH }}" ]; then
            echo "删除工作目录: ${{ env.WORKSPACE_PATH }}"
            rm -rf "${{ env.WORKSPACE_PATH }}"
          fi
          echo "最终磁盘空间状态:"
          df -h
